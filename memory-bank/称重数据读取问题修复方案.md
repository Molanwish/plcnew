# 称重数据读取问题修复方案

## 修复策略

基于前期分析，我们采用分阶段、低风险的修复策略，确保不影响系统其他功能的正常运行。修复将分为以下三个阶段进行：

1. **阶段1**：添加新的读取方法，不改变现有逻辑
2. **阶段2**：在确认新方法稳定后，修改监控线程
3. **阶段3**：全面替换旧的读取方式

本文档详细说明阶段1的实施步骤和验证方法。

## 阶段1：添加新的读取方法

### 1. 已完成的代码修改

1. **添加新的`read_weight_v2`方法**：
   - 在`CommunicationManager`类中添加了一个新方法`read_weight_v2`
   - 该方法使用正确的`read_holding_registers`API直接从PLC读取重量数据
   - 包含完善的错误处理和备选方案（如果新方法失败会尝试旧方法）
   - 正确解析PLC的`[值,0]`格式数据，并更新缓存

2. **添加测试方法**：
   - 在`CommunicationManager`类中增加了`test_weight_read_compare`方法
   - 该方法可比较新旧读取方法的结果和性能

3. **创建独立测试脚本**：
   - 创建了`test_weight_read.py`脚本
   - 该脚本可以独立测试新旧读取方法的效果

4. **UI层集成示例**：
   - 创建了`ui_integration_example.py`示例
   - 展示了如何在不改变现有代码的情况下集成新方法
   - 提供了新旧方法切换的机制

### 2. 测试步骤

1. **独立测试**：
   ```bash
   python test_weight_read.py
   ```
   这将测试新旧方法读取重量的结果差异，有助于验证新方法的准确性。

2. **UI集成测试**：
   ```bash
   python ui_integration_example.py
   ```
   这将模拟UI环境下使用新旧方法的情况，并实现自动切换测试。

### 3. 预期结果

成功的测试应该显示：

1. 新方法能够成功读取料斗1的重量（约78.8克）
2. 新方法在读取失败时会回退到旧方法，保证不会出现服务中断
3. 新方法和旧方法在UI层可以无缝切换

### 4. UI集成指南

对于实际生产系统，建议采取以下集成方式：

1. **创建配置开关**：
   ```python
   # 在配置文件或系统设置中添加
   use_new_weight_read_method = True  # 默认启用新方法
   ```

2. **修改现有代码**：
   ```python
   # 修改重量读取相关代码
   if config.use_new_weight_read_method:
       weight = comm_manager.read_weight_v2(hopper_id)
   else:
       weight = comm_manager.read_weight(hopper_id)
   ```

3. **添加UI控制（可选）**：
   - 在调试界面添加切换按钮
   - 显示当前使用的读取方法

### 5. 风险与回退方案

虽然风险已经被最小化，但仍需考虑以下情况：

1. **新方法完全失效**：
   - 由于内置了回退机制，即使新方法失败，也会尝试旧方法
   - 最坏情况下，将配置开关设为`False`，完全回退到旧方法

2. **性能问题**：
   - 新方法可能略慢于旧方法（因为增加了错误处理和尝试机制）
   - 但这种差异通常在毫秒级别，不会影响整体系统性能

## 下一步计划（阶段2）

在阶段1成功实施并稳定运行一段时间后，将进入阶段2：

1. 修改`_monitor_data`方法中的重量数据读取逻辑
2. 优化`read_registers_safe`函数或创建专用的安全读取函数
3. 进一步改进错误处理和日志记录

阶段2的具体实施计划将在阶段1验证成功后制定。 