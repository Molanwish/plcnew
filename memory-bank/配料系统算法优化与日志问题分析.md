# é…æ–™ç³»ç»Ÿç®—æ³•ä¼˜åŒ–ä¸æ—¥å¿—é—®é¢˜åˆ†æ

## å½“å‰å¼€å‘çŠ¶æ€æ‘˜è¦ (2023-07-04)

### é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡
æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªå·¥ä¸šé…æ–™ç³»ç»Ÿï¼Œç”¨äºç²¾ç¡®æ§åˆ¶ç‰©æ–™åŒ…è£…è¿‡ç¨‹ã€‚ç³»ç»Ÿé€šè¿‡æ§åˆ¶ç²—åŠ æ–™ã€ç»†åŠ æ–™ã€ç‚¹åŠ¨ç­‰é˜¶æ®µçš„å‚æ•°ï¼Œå®ç°å¯¹ç›®æ ‡é‡é‡çš„ç²¾ç¡®æ§åˆ¶ã€‚æ ¸å¿ƒç›®æ ‡æ˜¯é€šè¿‡ç®—æ³•ä¼˜åŒ–ï¼Œæé«˜é…æ–™ç²¾åº¦ï¼Œå‡å°‘è¯¯å·®ï¼ŒåŒæ—¶ç¼©çŸ­ç”Ÿäº§æ—¶é—´ã€‚

### å½“å‰å¼€å‘é˜¶æ®µ
æˆ‘ä»¬ç›®å‰å¤„äº**ç®—æ³•è‡ªä¼˜åŒ–ä¸æŒç»­å­¦ä¹ ç³»ç»Ÿè®¾è®¡é˜¶æ®µ**ï¼Œå·²å®ŒæˆåŸºç¡€è®¾è®¡ï¼Œå‡†å¤‡å¼€å§‹å®ç°ã€‚å…·ä½“è¿›å±•ï¼š

1. âœ… å·²å®Œæˆé…æ–™åŸºæœ¬æ§åˆ¶åŠŸèƒ½
2. âœ… å·²å®Œæˆç‰©æ–™ç±»å‹ç®¡ç†åŠŸèƒ½
3. âœ… å·²å®Œæˆç•Œé¢ä¿®å¤å’Œç¨³å®šæ€§ä¼˜åŒ–
4. ğŸ”„ æ­£åœ¨è®¾è®¡è‡ªä¼˜åŒ–ç®—æ³•å’ŒæŒç»­å­¦ä¹ æœºåˆ¶
5. ğŸ“… è®¡åˆ’å®ç°å•å‘¨æœŸè‡ªä¼˜åŒ–åŠŸèƒ½
6. ğŸ“… è®¡åˆ’å®ç°æ‰¹æ¬¡å…³è”å’Œè‡ªåŠ¨åˆ†ç±»åŠŸèƒ½

### ç³»ç»Ÿæ¶æ„ä¸æ¨¡å—ç»“æ„
ç³»ç»Ÿç”±ä»¥ä¸‹æ ¸å¿ƒæ¨¡å—ç»„æˆï¼š

1. **UIæ¨¡å—** (`src/ui/`)
   - `smart_production_tab.py`: ç”Ÿäº§ç•Œé¢ï¼ŒåŒ…æ‹¬å‚æ•°è®¾ç½®å’Œç›‘æ§
   - `sensitivity_panel.py`: å‚æ•°æ•æ„Ÿåº¦åˆ†æç•Œé¢
   - `base_tab.py`: UIåŸºç¡€ç»„ä»¶

2. **ç®—æ³•æ¨¡å—** (`src/adaptive_algorithm/`)
   - `adaptive_controller_with_micro_adjustment.py`: å¾®è°ƒæ§åˆ¶å™¨
   - `adaptive_controller_integrator.py`: æ§åˆ¶å™¨é›†æˆå™¨
   - `learning_system/`: å­¦ä¹ ç³»ç»Ÿå­æ¨¡å—
     - `enhanced_learning_data_repo.py`: å¢å¼ºå­¦ä¹ æ•°æ®ä»“åº“

3. **é€šä¿¡æ¨¡å—** (`src/comm/`)
   - è´Ÿè´£ä¸PLCç­‰ç¡¬ä»¶é€šä¿¡

4. **å·¥å…·æ¨¡å—** (`src/tools/`)
   - `enhanced_record_exporter.py`: å¢å¼ºè®°å½•å¯¼å‡ºå·¥å…·
   - `log_validator.py`: æ—¥å¿—éªŒè¯å·¥å…·

### ä»£ç é£æ ¼ä¸çº¦å®š
1. **å‘½åè§„èŒƒ**:
   - ç±»å: é©¼å³°å¼ (`AdaptiveController`)
   - æ–¹æ³•/å‡½æ•°: ä¸‹åˆ’çº¿å¼ (`adjust_parameters`)
   - å¸¸é‡: å…¨å¤§å†™ (`MAX_WEIGHT`)

2. **æ–‡æ¡£è§„èŒƒ**:
   - æ‰€æœ‰å…¬å…±æ–¹æ³•å¿…é¡»æœ‰docstring
   - å¤æ‚ç®—æ³•å¿…é¡»æœ‰è¯¦ç»†æ³¨é‡Š

3. **é”™è¯¯å¤„ç†**:
   - UIç›¸å…³ä»£ç å¿…é¡»æœ‰try-exceptå—
   - å…³é”®æ“ä½œå¿…é¡»æœ‰æ—¥å¿—è®°å½•

### å·²è§£å†³çš„é—®é¢˜
1. **é‡é‡æ•°æ®è¯»å–é—®é¢˜**:
   - ä¿®å¤äº†PLCé‡é‡è¯»å–åŠŸèƒ½ï¼Œç¡®ä¿æ•°æ®æ­£ç¡®æ€§

2. **æ—¥å¿—ç³»ç»Ÿé”™è¯¯**:
   - è§£å†³äº†`'tuple' object has no attribute 'levelno'`é”™è¯¯
   - æ”¹è¿›äº†æ—¥å¿—è®°å½•å’Œå¤„ç†æœºåˆ¶

3. **UIæ˜¾ç¤ºé—®é¢˜**:
   - ä¿®å¤äº†å¤šå¤„f-stringä¸­ä½¿ç”¨ä¸­æ–‡å¼•å·å¯¼è‡´çš„è¯­æ³•é”™è¯¯
   - å®Œå–„äº†UIæ›´æ–°é˜Ÿåˆ—å¤„ç†æœºåˆ¶

4. **ç‰©æ–™ç®¡ç†åŠŸèƒ½ç¼ºå¤±**:
   - å®ç°äº†ç‰©æ–™é€‰æ‹©ã€æ·»åŠ å’Œç®¡ç†åŠŸèƒ½
   - æ·»åŠ äº†ç‰©æ–™å‚æ•°è®°å¿†å’Œåº”ç”¨åŠŸèƒ½

### æ­£åœ¨è§£å†³çš„é—®é¢˜
1. **å•ä¸€å‚æ•°è°ƒæ•´çš„å±€é™æ€§**:
   - ç›®å‰ç®—æ³•ä»…èƒ½è°ƒæ•´ç²¾åŠ æå‰é‡
   - éœ€è¦å®ç°å¤šå‚æ•°ååŒè°ƒæ•´

2. **ç¼ºä¹è‡ªé€‚åº”èƒ½åŠ›**:
   - ç³»ç»Ÿæ— æ³•æ ¹æ®è¿‡å¾€ç»éªŒè‡ªåŠ¨ä¼˜åŒ–
   - éœ€è¦å»ºç«‹æŒç»­å­¦ä¹ æœºåˆ¶

3. **æ•°æ®åˆ†æèƒ½åŠ›ä¸è¶³**:
   - ç¼ºå°‘å¯¹å†å²æ•°æ®çš„æ·±å…¥åˆ†æ
   - éœ€è¦å®ç°è‡ªåŠ¨åˆ†ç±»å’Œæ¨¡å¼è¯†åˆ«

### ä¸‹ä¸€æ­¥å·¥ä½œé‡ç‚¹
1. å®ç°`adjust_parameters_after_cycle`æ–¹æ³•ï¼Œæ”¯æŒå•å‘¨æœŸè‡ªä¼˜åŒ–
2. æ‰©å±•`EnhancedPackagingRecord`ç±»ï¼ŒåŠ å…¥è¯¦ç»†ç”Ÿäº§æ•°æ®
3. å¼€å‘`CumulativeExperienceModel`ç±»ï¼Œå®ç°ç»éªŒç´¯ç§¯å’Œå­¦ä¹ 
4. æ·»åŠ æ‰¹æ¬¡å…³è”å’Œè‡ªåŠ¨åˆ†ç±»åŠŸèƒ½
5. å®ç°ç»éªŒæ•°æ®å¯¼å…¥å¯¼å‡ºåŠŸèƒ½

### æŠ€æœ¯å€ºåŠ¡
1. éœ€é‡æ„éƒ¨åˆ†UIä»£ç ï¼Œå‡å°‘é‡å¤é€»è¾‘
2. éœ€ä¸ºæ ¸å¿ƒç®—æ³•æ·»åŠ å•å…ƒæµ‹è¯•
3. éœ€ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ï¼Œå‡å°‘ç”Ÿäº§è¿‡ç¨‹ä¸­çš„å»¶è¿Ÿ

### æœ€æ–°è®¨è®ºå†…å®¹
å½“å‰æ­£åœ¨æ·±å…¥æ¢è®¨ç®—æ³•è‡ªä¼˜åŒ–å’ŒæŒç»­å­¦ä¹ ç³»ç»Ÿè®¾è®¡ï¼Œç„¦ç‚¹æ˜¯è®©ç³»ç»Ÿèƒ½å¤Ÿä»æ¯æ¬¡ç”Ÿäº§ä¸­å­¦ä¹ å¹¶è‡ªæˆ‘ä¼˜åŒ–ï¼Œé€æ¸æé«˜é…æ–™ç²¾åº¦ã€‚å·²è®¾è®¡äº†å•å‘¨æœŸè‡ªä¼˜åŒ–æœºåˆ¶ã€å¢å¼ºè®°å½•ç»“æ„ã€æŒç»­å­¦ä¹ æ¨¡å‹ç­‰æ ¸å¿ƒç»„ä»¶ï¼Œä¸‹ä¸€æ­¥å°†å¼€å§‹å®ç°è¿™äº›åŠŸèƒ½ã€‚

## å½“å‰ç³»ç»ŸçŠ¶æ€è¯„ä¼°

### 1. é‡é‡æ•°æ®è¯»å–é—®é¢˜å·²è§£å†³

æˆ‘ä»¬æˆåŠŸä¿®å¤äº†PLCé‡é‡è¯»å–é—®é¢˜ï¼Œç³»ç»Ÿç°åœ¨èƒ½å¤Ÿæ­£ç¡®è¯»å–ç§°é‡æ•°æ®ã€‚ä¿®å¤æ–¹æ¡ˆåŒ…æ‹¬ï¼š

- åœ¨`ModbusRTUClient`ç±»ä¸­æ·»åŠ äº†`read_holding_registers`æ–¹æ³•ä½œä¸ºAPIå…¼å®¹å±‚
- ä¿®æ”¹`read_weight`æ–¹æ³•ç›´æ¥ä½¿ç”¨æ–°å®ç°çš„`read_weight_v2`æ–¹æ³•
- åˆ›å»ºéªŒè¯è„šæœ¬ç¡®è®¤ä¿®å¤æœ‰æ•ˆ

### 2. å½“å‰æµ‹è¯•æ•°æ®åˆ†æ

```
åŒ…å·  ç›®æ ‡é‡é‡(å…‹)  å®é™…é‡é‡(å…‹)  åå·®(å…‹)  ç”Ÿäº§æ—¶é—´(ç§’)
1     100         102.2        2.2      11.64
2     100         101.8        1.8      11.53
3     100         101.8        1.8      11.72
4     100         101.8        1.8      12.04
5     100         101.8        1.8      11.7
6     100         101.8        1.8      12.05
7     100         101.6        1.6      11.1
8     100         101.6        1.6      10.35
9     100         101.6        1.6      11.87
10    100         101.8        1.8      12.63
```

æ•°æ®è§‚å¯Ÿï¼š
- è¯¯å·®èŒƒå›´åœ¨1.6-2.2å…‹ä¹‹é—´ï¼Œç›¸å¯¹ç¨³å®š
- å¤§å¤šæ•°åŒ…çš„è¯¯å·®ä¸º1.8å…‹
- ç”Ÿäº§æ—¶é—´çº¦ä¸º10.35-12.63ç§’ï¼Œå¹³å‡çº¦11.7ç§’

## é—®é¢˜åˆ†æ

### 1. ç®—æ³•è°ƒæ•´è¿‡äºä¿å®ˆ

**ç°çŠ¶**ï¼š
- ç›®å‰ç®—æ³•ä»…è°ƒæ•´è½å·®å€¼ï¼ˆç²¾åŠ æå‰é‡ï¼‰
- æ²¡æœ‰è°ƒæ•´å¿«åŠ é€Ÿåº¦ã€æ…¢åŠ é€Ÿåº¦å’Œå¿«åŠ æå‰é‡
- è¯¯å·®è™½å·²æ”¶æ•›ä½†ä¿æŒåœ¨æ­£å‘åå·®1.6-2.2å…‹ï¼Œæœªèƒ½è¿›ä¸€æ­¥ä¼˜åŒ–

**åŸå› åˆ†æ**ï¼š
- å•ä¸€å‚æ•°è°ƒæ•´çš„å±€é™æ€§ï¼šåªè°ƒæ•´è½å·®å€¼æ— æ³•è¦†ç›–å…¨éƒ¨ä¼˜åŒ–ç©ºé—´
- ç¼ºä¹å‚æ•°é—´å…³ç³»æ¨¡å‹ï¼šæœªèƒ½ç†è§£å‚æ•°é—´çš„ç›¸äº’å½±å“
- ä¿å®ˆç­–ç•¥ï¼šå¯èƒ½å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œé¿å…å¤§å¹…è°ƒæ•´å¯¼è‡´ç²¾åº¦æ¶åŒ–

### 2. æ•°æ®è®°å½•ä¸è¶³

**ç°çŠ¶**ï¼š
- ç°æœ‰è®°å½•ä»…åŒ…å«æ‰¹æ¬¡å·ã€ç›®æ ‡é‡é‡ã€å®é™…é‡é‡ã€è¯¯å·®å’Œç”Ÿäº§æ—¶é—´
- ç¼ºå°‘æ¯ä¸ªæ‰¹æ¬¡çš„å‚æ•°è®¾ç½®è®°å½•
- ç¼ºå°‘è¿‡ç¨‹æ•°æ®ï¼ˆå¦‚å¿«åŠ ã€æ…¢åŠ é˜¶æ®µè¯¦æƒ…ï¼‰

**é—®é¢˜**ï¼š
- æ— æ³•å…³è”å‚æ•°å˜åŒ–ä¸ç»“æœå˜åŒ–
- ç³»ç»Ÿéš¾ä»¥å­¦ä¹ å‚æ•°è°ƒæ•´çš„æ•ˆæœ
- æ— æ³•æ„å»ºæœ‰æ•ˆçš„å­¦ä¹ æ¨¡å‹

### 3. æ—¥å¿—ç³»ç»Ÿé”™è¯¯

**ç°çŠ¶**ï¼š
- æ—¥å¿—ä¸­æ˜¾ç¤ºå¤§é‡é”™è¯¯ï¼š`æ—¥å¿—å¤„ç†é”™è¯¯: 'tuple' object has no attribute 'levelno'`
- ç¨‹åºä¸­çœ‹ä¸åˆ°æ­£ç¡®çš„æ—¥å¿—è¾“å‡º

**åŸå› åˆ†æ**ï¼š
- å¯èƒ½æ˜¯æ—¥å¿—æ ¼å¼åŒ–é—®é¢˜ï¼šä»£ç æŸå¤„å°è¯•ä½¿ç”¨å…ƒç»„è€Œéæ­£ç¡®çš„æ—¥å¿—æ ¼å¼
- é”™è¯¯ä½¿ç”¨æ¨¡å¼å¯èƒ½ç±»ä¼¼ï¼š`logger.info((message, arg1, arg2))`è€Œé`logger.info(message, arg1, arg2)`
- è¿™å¯¼è‡´æ—¥å¿—ç³»ç»Ÿæ— æ³•æ­£å¸¸è®°å½•ç®—æ³•è°ƒæ•´è¿‡ç¨‹

### 4. ä¼˜åŒ–æ•ˆæœä¸æ˜æ˜¾é—®é¢˜

**ç°çŠ¶**ï¼š
- è¯¯å·®ç¨³å®šåœ¨2.2-2.8å…‹ä¹‹é—´ï¼Œæœªéšæ—¶é—´å‡å°
- å‚æ•°è°ƒæ•´æœªèƒ½æœ‰æ•ˆå‡å°‘è¯¯å·®
- å½“å‰æ‰¹æ¬¡10ä¸ªåŒ…è£…æ ·æœ¬å¹³å‡è¯¯å·®2.54å…‹ï¼Œæ ‡å‡†å·®0.21å…‹

**é—®é¢˜åˆ†æ**ï¼š
1. **è°ƒæ•´ç­–ç•¥è¿‡äºä¿å®ˆ**ï¼š
   - ç°æœ‰ä»£ç å¯èƒ½ä½¿ç”¨è¾ƒå°çš„è°ƒæ•´æ¯”ä¾‹ï¼ˆå¦‚0.1å€è¯¯å·®ï¼‰
   - å¯èƒ½é™åˆ¶äº†å•æ¬¡è°ƒæ•´æœ€å¤§å€¼
   - å¯èƒ½åªè°ƒæ•´ä¸€ä¸ªå‚æ•°ç»´åº¦

2. **è¯¯å·®æ¨¡å¼åˆ†æä¸è¶³**ï¼š
   - æœªåŒºåˆ†éšæœºè¯¯å·®å’Œç³»ç»Ÿæ€§è¯¯å·®
   - æœªè€ƒè™‘è¯¯å·®è¶‹åŠ¿ï¼ˆæ˜¯å¦æŒç»­æ­£åå·®æˆ–è´Ÿåå·®ï¼‰
   - ç¼ºå°‘å¯¹å†å²æ•°æ®çš„åˆ†æåˆ©ç”¨

3. **å‚æ•°ç©ºé—´æ¢ç´¢ä¸è¶³**ï¼š
   - å¯èƒ½å±€é™åœ¨å½“å‰å‚æ•°é™„è¿‘çš„å°èŒƒå›´å†…è°ƒæ•´
   - æœªå°è¯•å…¶ä»–å‚æ•°ç»„åˆå¯èƒ½è·å¾—çš„æ›´å¥½æ•ˆæœ

**å…·ä½“æ”¹è¿›æ–¹æ¡ˆ**ï¼š

1. **æ›´ç§¯æçš„å‚æ•°è°ƒæ•´ç­–ç•¥**ï¼š
```python
def adjust_parameters_aggressive(self, error, target_weight):
    """æ›´ç§¯æçš„å‚æ•°è°ƒæ•´ç­–ç•¥"""
    # è®¡ç®—ç›¸å¯¹è¯¯å·®ç‡
    error_rate = error / target_weight * 100  # ç™¾åˆ†æ¯”è¯¯å·®
    
    # åŸæœ‰å‚æ•°
    original_params = {
        "coarse_advance": self.coarse_advance,
        "fine_advance": self.fine_advance
    }
    
    # æ–°çš„è°ƒæ•´ç³»æ•° - æ›´ç§¯æçš„è°ƒæ•´
    if abs(error_rate) > 1.0:  # è¯¯å·®è¶…è¿‡1%
        # è¯¯å·®ä¸ºæ­£(å®é™…>ç›®æ ‡)ï¼Œå‡å°æå‰é‡ï¼›è¯¯å·®ä¸ºè´Ÿï¼Œå¢åŠ æå‰é‡
        direction = -1 if error > 0 else 1
        
        # è°ƒæ•´ç³»æ•°éšè¯¯å·®å¢å¤§è€Œå¢å¤§ï¼Œä½†è®¾ç½®ä¸Šé™é˜²æ­¢è¿‡åº¦è°ƒæ•´
        adjustment_factor = min(0.3, abs(error_rate) / 10)  # æœ€é«˜å¯è¾¾30%è°ƒæ•´
        
        # ä¸»è¦è°ƒæ•´è½å·®å€¼
        self.fine_advance += direction * adjustment_factor * self.fine_advance
        
        # åŒæ—¶è°ƒæ•´å¿«åŠ æå‰é‡(å°å¹…åº¦)
        coarse_factor = adjustment_factor * 0.5  # å¿«åŠ è°ƒæ•´å¹…åº¦ä¸ºè½å·®è°ƒæ•´çš„ä¸€åŠ
        self.coarse_advance += direction * coarse_factor * self.coarse_advance
        
        # ç¡®ä¿å‚æ•°åœ¨åˆç†èŒƒå›´å†…
        self.fine_advance = max(0.5, min(5.0, self.fine_advance))  # 0.5-5.0å…‹ä¹‹é—´
        self.coarse_advance = max(10.0, min(50.0, self.coarse_advance))  # 10-50å…‹ä¹‹é—´
        
        logger.info(f"ç§¯æè°ƒæ•´å‚æ•° - è¯¯å·®: {error}g ({error_rate:.2f}%), æ–¹å‘: {direction}")
        logger.info(f"è½å·®å€¼: {original_params['fine_advance']:.2f} -> {self.fine_advance:.2f}")
        logger.info(f"å¿«åŠ æå‰é‡: {original_params['coarse_advance']:.2f} -> {self.coarse_advance:.2f}")
    
    return {
        "coarse_advance": self.coarse_advance,
        "fine_advance": self.fine_advance
    }
```

2. **è¯¯å·®è¶‹åŠ¿åˆ†æä¸ç³»ç»Ÿæ€§åå·®è¯†åˆ«**ï¼š
```python
def analyze_error_trend(self, recent_errors, window_size=5):
    """åˆ†æè¯¯å·®è¶‹åŠ¿å’Œç³»ç»Ÿæ€§åå·®"""
    if len(recent_errors) < window_size:
        return {"has_trend": False, "systematic_bias": 0}
    
    # è·å–æœ€è¿‘næ¬¡åŒ…è£…çš„è¯¯å·®
    recent_window = recent_errors[-window_size:]
    
    # è®¡ç®—å¹³å‡è¯¯å·®(ç³»ç»Ÿæ€§åå·®)
    avg_error = sum(recent_window) / len(recent_window)
    
    # åˆ¤æ–­æ˜¯å¦ä¸ºç³»ç»Ÿæ€§åå·®(è¿ç»­åŒå‘è¯¯å·®)
    all_positive = all(err > 0 for err in recent_window)
    all_negative = all(err < 0 for err in recent_window)
    
    # è®¡ç®—æ ‡å‡†å·®(éšæœºè¯¯å·®æˆåˆ†)
    import math
    std_dev = math.sqrt(sum((x - avg_error) ** 2 for x in recent_window) / len(recent_window))
    
    # è¯¯å·®åˆ†å¸ƒç±»å‹
    error_type = "éšæœºè¯¯å·®"
    if abs(avg_error) > std_dev and (all_positive or all_negative):
        error_type = "ç³»ç»Ÿæ€§åå·®"
    
    # è¯¯å·®è¶‹åŠ¿(æ˜¯å¦åœ¨å‡å°)
    trend_improving = False
    if len(recent_errors) >= window_size * 2:
        prev_window = recent_errors[-(window_size*2):-window_size]
        prev_avg = sum(prev_window) / len(prev_window)
        trend_improving = abs(avg_error) < abs(prev_avg)
    
    return {
        "avg_error": avg_error,
        "std_dev": std_dev,
        "error_type": error_type,
        "has_trend": all_positive or all_negative,
        "trend_improving": trend_improving,
        "systematic_bias": avg_error if (all_positive or all_negative) else 0
    }
```

3. **å‚æ•°ç©ºé—´æ¢ç´¢åŠŸèƒ½**ï¼š
```python
def explore_parameter_space(self, target_weight, current_performance):
    """æ¢ç´¢æ›´ä¼˜çš„å‚æ•°ç»„åˆ"""
    # å½“å‰å‚æ•°å’Œæ€§èƒ½
    current_params = {
        "coarse_advance": self.coarse_advance,
        "fine_advance": self.fine_advance
    }
    
    # åªæœ‰å½“æ€§èƒ½ä¸ä½³æ—¶æ‰æ¢ç´¢(é¿å…ç ´åå·²ç»å¾ˆå¥½çš„å‚æ•°)
    if abs(current_performance["avg_error"]) < 1.0:
        logger.info("å½“å‰æ€§èƒ½è‰¯å¥½ï¼Œè·³è¿‡å‚æ•°æ¢ç´¢")
        return current_params
    
    # å®šä¹‰æ¢ç´¢ç©ºé—´(åœ¨å½“å‰å‚æ•°å‘¨å›´å°è¯•ä¸åŒç»„åˆ)
    coarse_variations = [0.8, 0.9, 1.0, 1.1, 1.2]  # å½“å‰å€¼çš„80%-120%
    fine_variations = [0.7, 0.85, 1.0, 1.15, 1.3]  # å½“å‰å€¼çš„70%-130%
    
    logger.info("å¼€å§‹å‚æ•°ç©ºé—´æ¢ç´¢...")
    
    # åˆ›å»ºæ¢ç´¢è®¡åˆ’
    exploration_plan = []
    for c_var in coarse_variations:
        for f_var in fine_variations:
            if c_var == 1.0 and f_var == 1.0:
                continue  # è·³è¿‡å½“å‰å‚æ•°ç»„åˆ
            
            new_params = {
                "coarse_advance": current_params["coarse_advance"] * c_var,
                "fine_advance": current_params["fine_advance"] * f_var
            }
            exploration_plan.append(new_params)
    
    # æŒ‰ç…§æ¢ç´¢è®¡åˆ’è¿›è¡Œæµ‹è¯•(å®é™…å®ç°ä¸­éœ€è¦ä¸ç”Ÿäº§ç³»ç»Ÿé›†æˆ)
    best_params = current_params
    best_error = abs(current_performance["avg_error"])
    
    # å®é™…ä»£ç ä¸­éœ€è¦æ›¿æ¢ä¸ºçœŸå®æµ‹è¯•
    # è¿™é‡Œä»…ä½œä¸ºç¤ºèŒƒä¼ªä»£ç 
    for params in exploration_plan:
        # è®¾ç½®å‚æ•°
        self.coarse_advance = params["coarse_advance"]
        self.fine_advance = params["fine_advance"]
        
        # è¿›è¡Œå¤šæ¬¡æµ‹è¯•å¹¶è®¡ç®—å¹³å‡è¯¯å·®
        test_results = self._simulate_multiple_packaging(target_weight, test_count=3)
        avg_test_error = sum(r["error"] for r in test_results) / len(test_results)
        
        logger.info(f"æµ‹è¯•å‚æ•°: coarse={params['coarse_advance']:.2f}, fine={params['fine_advance']:.2f}, è¯¯å·®={avg_test_error:.2f}g")
        
        # å¦‚æœæ‰¾åˆ°æ›´å¥½çš„å‚æ•°ç»„åˆï¼Œè®°å½•ä¸‹æ¥
        if abs(avg_test_error) < best_error:
            best_error = abs(avg_test_error)
            best_params = params.copy()
    
    # åº”ç”¨æœ€ä½³å‚æ•°
    logger.info(f"æ¢ç´¢å®Œæˆï¼Œæœ€ä½³å‚æ•°: coarse={best_params['coarse_advance']:.2f}, fine={best_params['fine_advance']:.2f}, é¢„æœŸè¯¯å·®={best_error:.2f}g")
    self.coarse_advance = best_params["coarse_advance"]
    self.fine_advance = best_params["fine_advance"]
    
    return best_params
```

4. **å¤šç»´åº¦å‚æ•°ååŒä¼˜åŒ–**ï¼š
```python
def optimize_multi_dimensional(self, target_weight, error, packaging_time):
    """å¤šç»´åº¦å‚æ•°ååŒä¼˜åŒ–"""
    # æ€§èƒ½ç›®æ ‡
    target_error = 0.5  # ç›®æ ‡è¯¯å·®0.5å…‹ä»¥å†…
    target_time = 6.0   # ç›®æ ‡æ—¶é—´6ç§’ä»¥å†…
    
    # è®¡ç®—æ€§èƒ½å·®è·
    error_gap = abs(error) - target_error
    time_gap = packaging_time - target_time
    
    # æ ¹æ®é‡è¦æ€§åˆ†é…æƒé‡(ç²¾åº¦ä¼˜å…ˆ)
    error_weight = 0.7
    time_weight = 0.3
    
    # åªæœ‰åœ¨ç²¾åº¦åˆæ ¼çš„æƒ…å†µä¸‹æ‰ä¼˜åŒ–æ—¶é—´
    if abs(error) <= target_error:
        error_weight = 0.3
        time_weight = 0.7
    
    # å‚æ•°è°ƒæ•´æ–¹å‘
    error_direction = -1 if error > 0 else 1  # è¯¯å·®ä¸ºæ­£ï¼Œå‡å°æå‰é‡
    time_direction = -1 if time_gap > 0 else 0  # æ—¶é—´è¿‡é•¿ï¼Œå°è¯•åŠ é€Ÿ
    
    # å¹³è¡¡å¤šç›®æ ‡çš„å‚æ•°è°ƒæ•´
    params = {}
    
    # è°ƒæ•´è½å·®å€¼(ä¸»è¦å½±å“ç²¾åº¦)
    self.fine_advance += error_direction * error_weight * min(0.2, abs(error)/10) * self.fine_advance
    params["fine_advance"] = max(0.5, min(5.0, self.fine_advance))
    
    # è°ƒæ•´å¿«åŠ æå‰é‡(åŒæ—¶å½±å“ç²¾åº¦å’Œæ—¶é—´)
    self.coarse_advance += error_direction * error_weight * min(0.1, abs(error)/20) * self.coarse_advance
    self.coarse_advance += time_direction * time_weight * min(0.2, abs(time_gap)/10) * self.coarse_advance
    params["coarse_advance"] = max(10.0, min(50.0, self.coarse_advance))
    
    # è°ƒæ•´é€Ÿåº¦å‚æ•°(ä¸»è¦å½±å“æ—¶é—´)
    if time_gap > 1.0:  # æ—¶é—´å·®è·è¾ƒå¤§æ—¶æ‰è°ƒæ•´é€Ÿåº¦
        self.coarse_speed += time_direction * time_weight * min(2, abs(time_gap)/2)
        params["coarse_speed"] = max(20, min(50, self.coarse_speed))
    
    return params
```

**å®æ–½è®¡åˆ’**ï¼š

1. é¦–å…ˆå®ç°**ç³»ç»Ÿæ€§è¯¯å·®åˆ†æ**ï¼š
   - åœ¨`AdaptiveController`ç±»ä¸­æ·»åŠ `analyze_error_trend`æ–¹æ³•
   - ä¿®æ”¹`_run_production`ä¿å­˜æœ€è¿‘10æ¬¡åŒ…è£…çš„è¯¯å·®æ•°æ®
   - åœ¨æ¯æ¬¡åŒ…è£…åè°ƒç”¨åˆ†æå‡½æ•°ï¼Œåˆ¤æ–­è¯¯å·®ç±»å‹

2. å…¶æ¬¡å®ç°**æ›´ç§¯æçš„å‚æ•°è°ƒæ•´ç­–ç•¥**ï¼š
   - æ›¿æ¢ç°æœ‰çš„è°ƒæ•´é€»è¾‘ä¸º`adjust_parameters_aggressive`
   - å¢åŠ æ—¥å¿—è®°å½•ï¼Œè§‚å¯Ÿå‚æ•°å˜åŒ–å’Œæ•ˆæœ

3. æœ€åå®ç°**å‚æ•°ç©ºé—´æ¢ç´¢åŠŸèƒ½**ï¼š
   - æ¯10æ¬¡åŒ…è£…è‡ªåŠ¨è§¦å‘ä¸€æ¬¡å‚æ•°ç©ºé—´æ¢ç´¢
   - ä½¿ç”¨å°æ‰¹é‡æµ‹è¯•(3-5æ¬¡)è¯„ä¼°å€™é€‰å‚æ•°ç»„åˆ
   - å¦‚æœ‰æ˜¾è‘—æ”¹è¿›åˆ™åº”ç”¨æ–°å‚æ•°

**é¢„æœŸæ•ˆæœ**ï¼š
- ç³»ç»Ÿèƒ½å¤Ÿè¯†åˆ«å¹¶ä¿®æ­£ç³»ç»Ÿæ€§åå·®ï¼Œè€Œä¸åªæ˜¯éšæœºæ³¢åŠ¨
- è¯¯å·®èƒ½å¤Ÿä»å½“å‰çš„~2.5å…‹æ˜¾è‘—é™ä½åˆ°1å…‹ä»¥å†…
- å‚æ•°è°ƒæ•´æ›´åŠ ç§¯æä¸»åŠ¨ï¼Œåœ¨å°‘é‡åŒ…è£…å‘¨æœŸåå³å¯æ”¶æ•›åˆ°æœ€ä¼˜å‚æ•°

## æ–™æ–—é˜¶æ®µä¿¡å·ç›‘æ§å®ç°åˆ†æ (2023-07-05)

### èƒŒæ™¯ä¸éœ€æ±‚

ç³»ç»Ÿå½“å‰å·²å®ç°å¯¹æ–™æ–—åˆ°é‡ä¿¡å·ï¼ˆM91-M96ï¼‰çš„ç›‘æµ‹å’Œå¤„ç†ï¼Œä½†ç¼ºå°‘å¯¹é…æ–™è¿‡ç¨‹ä¸­å„ä¸ªé˜¶æ®µï¼ˆå¿«åŠ ã€æ…¢åŠ ã€ç²¾åŠ ï¼‰çš„ä¿¡å·ç›‘æ§ã€‚è¿™äº›Måœ°å€å¼€å¤´çš„ä¿¡å·å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç²¾ç¡®äº†è§£æ¯ä¸ªé˜¶æ®µçš„è¿è¡ŒçŠ¶æ€å’Œè€—æ—¶ï¼Œä¸ºé…æ–™å‚æ•°ä¼˜åŒ–å’Œæ•…éšœè¯Šæ–­æä¾›é‡è¦ä¾æ®ã€‚

### ä»·å€¼åˆ†æ

1. **å·¥è‰ºå‚æ•°ä¼˜åŒ–**ï¼šç²¾ç¡®è®°å½•æ¯ä¸ªé˜¶æ®µè€—æ—¶ï¼Œå¯ä»¥æ›´å‡†ç¡®åœ°ä¼˜åŒ–é…æ–™å‚æ•°
2. **é—®é¢˜è¯Šæ–­èƒ½åŠ›**ï¼šå½“æŸé˜¶æ®µæ—¶é—´å¼‚å¸¸æ—¶ï¼Œå¯å¿«é€Ÿå®šä½é—®é¢˜
3. **æ•°æ®åˆ†æç»´åº¦**ï¼šä¸ºç‰©æ–™ç‰¹æ€§åˆ†ææä¾›æ›´å¤šç»´åº¦æ•°æ®
4. **ç”Ÿäº§æ•ˆç‡è¯„ä¼°**ï¼šæ ¹æ®å„é˜¶æ®µæ—¶é—´åˆ†å¸ƒï¼Œè¯„ä¼°ç”Ÿäº§æ•ˆç‡ç“¶é¢ˆ

### å®ç°æ–¹æ¡ˆè®¾è®¡

éœ€è¦åœ¨ç°æœ‰ç³»ç»ŸåŸºç¡€ä¸Šè¿›è¡Œä»¥ä¸‹æ‰©å±•ï¼š

1. **é€šä¿¡æ¨¡å—æ‰©å±•**ï¼š
   - åœ¨`CommunicationManager`ä¸­æ·»åŠ é˜¶æ®µä¿¡å·è¯»å–æ–¹æ³•
   - å»ºç«‹æ–™æ–—ç´¢å¼•ä¸å¯¹åº”ä¿¡å·åœ°å€çš„æ˜ å°„å…³ç³»

2. **æ§åˆ¶æµç¨‹æ‰©å±•**ï¼š
   - åœ¨`_real_packaging_with_micro_adjustment`æ–¹æ³•ä¸­æ·»åŠ é˜¶æ®µä¿¡å·ç›‘æµ‹
   - è®°å½•å„é˜¶æ®µå¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œè®¡ç®—å„é˜¶æ®µè€—æ—¶

3. **æ•°æ®ç»“æ„æ‰©å±•**ï¼š
   - æ‰©å±•`EnhancedPackagingRecord`ï¼Œå¢åŠ é˜¶æ®µæ—¶é—´å­—æ®µ
   - ä¿®æ”¹æ•°æ®å­˜å‚¨é€»è¾‘ï¼Œä¿å­˜é˜¶æ®µæ—¶é—´ä¿¡æ¯

4. **UIå±•ç¤ºæ‰©å±•**ï¼š
   - åœ¨ç”Ÿäº§ç•Œé¢æ·»åŠ å„é˜¶æ®µæ—¶é—´æ˜¾ç¤º
   - æä¾›å†å²æ•°æ®å¯¹æ¯”å’Œè¶‹åŠ¿åˆ†æ

### æ ¸å¿ƒä»£ç è®¾è®¡

```python
# åœ¨CommunicationManagerä¸­æ·»åŠ é˜¶æ®µä¿¡å·è¯»å–æ–¹æ³•
def read_hopper_phase_signals(self, hopper_index):
    """è¯»å–æŒ‡å®šæ–™æ–—çš„å„é˜¶æ®µä¿¡å·
    
    Args:
        hopper_index: æ–™æ–—ç´¢å¼•(1-6)
        
    Returns:
        dict: åŒ…å«å„é˜¶æ®µä¿¡å·çŠ¶æ€çš„å­—å…¸
    """
    if not self.is_connected:
        return None
        
    try:
        # å‡è®¾é˜¶æ®µä¿¡å·åœ°å€æ˜ å°„ (éœ€è¦æ ¹æ®å®é™…PLCåœ°å€è°ƒæ•´)
        base_addr = (hopper_index - 1) * 10 + 200  # ç¤ºä¾‹åŸºå€
        
        return {
            "fast_feeding": self.read_coil(base_addr),      # å¿«åŠ ä¿¡å·
            "slow_feeding": self.read_coil(base_addr + 1),  # æ…¢åŠ ä¿¡å·
            "fine_feeding": self.read_coil(base_addr + 2),  # ç²¾åŠ ä¿¡å·
        }
    except Exception as e:
        logging.error(f"è¯»å–æ–™æ–—{hopper_index}é˜¶æ®µä¿¡å·å¤±è´¥: {e}")
        return None

# åœ¨SmartProductionTabä¸­æ·»åŠ é˜¶æ®µæ—¶é—´è®°å½•
def _real_packaging_with_micro_adjustment(self, package_id, target_weight):
    # ... ç°æœ‰ä»£ç  ...
    
    # é˜¶æ®µæ—¶é—´è®°å½•
    phase_times = {
        "fast_feeding": 0,
        "slow_feeding": 0, 
        "fine_feeding": 0
    }
    
    current_phase = None
    phase_start_time = time.time()
    
    # åŒ…è£…å¾ªç¯
    while current_stage != MicroControllerStage.COMPLETE:
        # ... ç°æœ‰ä»£ç  ...
        
        # è¯»å–é˜¶æ®µä¿¡å·
        phase_signals = self.comm_manager.read_hopper_phase_signals(self.hopper_index)
        
        # æ£€æµ‹é˜¶æ®µå˜åŒ–
        if phase_signals:
            new_phase = None
            if phase_signals["fast_feeding"]:
                new_phase = "fast_feeding"
            elif phase_signals["slow_feeding"]:
                new_phase = "slow_feeding"
            elif phase_signals["fine_feeding"]:
                new_phase = "fine_feeding"
                
            # å¦‚æœé˜¶æ®µå‘ç”Ÿå˜åŒ–ï¼Œè®°å½•æ—¶é—´
            if new_phase != current_phase and current_phase is not None:
                phase_times[current_phase] = time.time() - phase_start_time
                phase_start_time = time.time()
                
                # è®°å½•é˜¶æ®µå˜åŒ–æ—¥å¿—
                logger.info(f"æ–™æ–—{self.hopper_index}é˜¶æ®µå˜åŒ–: {current_phase} -> {new_phase}, è€—æ—¶: {phase_times[current_phase]:.2f}s")
                
            current_phase = new_phase
    
    # è®°å½•æœ€åé˜¶æ®µæ—¶é—´
    if current_phase:
        phase_times[current_phase] = time.time() - phase_start_time
    
    # ä¿å­˜é˜¶æ®µæ—¶é—´åˆ°è®°å½•
    # ... ç°æœ‰ä»£ç  ...
```

### éš¾åº¦è¯„ä¼°

**å®ç°éš¾åº¦**: ä¸­ä½
- å·²æœ‰ä¿¡å·ç›‘æµ‹åŸºç¡€æ¶æ„å¯å¤ç”¨
- ç±»ä¼¼çš„åˆ°é‡ä¿¡å·é€»è¾‘å¯ä»¥å‚è€ƒ
- ä¸»è¦æ˜¯æ·»åŠ ä»£ç ï¼Œè¾ƒå°‘ä¿®æ”¹ç°æœ‰åŠŸèƒ½

**å¼€å‘å·¥ä½œé‡**: ä¸­ç­‰
- éœ€è¦ä¿®æ”¹3-4ä¸ªæ–‡ä»¶
- éœ€è¦æ·»åŠ UIå…ƒç´ æ˜¾ç¤ºé˜¶æ®µæ—¶é—´
- éœ€è¦æ‰©å±•æ•°æ®å­˜å‚¨ç»“æ„

### é£é™©è¯„ä¼°

**ä½é£é™©å› ç´ **:
- åªè¯»å–ä¿¡å·ï¼Œä¸å¹²é¢„æ§åˆ¶æµç¨‹
- ç°æœ‰åŠŸèƒ½åŸºæœ¬ä¸å—å½±å“
- å¯ä»¥æ¸è¿›å®ç°ï¼Œå…ˆç›‘æ§åå±•ç¤º

**æ½œåœ¨é£é™©ç‚¹**:
1. **ä¿¡å·é‡‡æ ·é¢‘ç‡**: å¦‚æœé‡‡æ ·é—´éš”è¿‡é•¿ï¼Œå¯èƒ½é”™è¿‡çŸ­æš‚çŠ¶æ€
   - è§£å†³æ–¹æ¡ˆ: åœ¨å¾ªç¯ä¸­å¢åŠ é€‚å½“çš„é‡‡æ ·é¢‘ç‡æ§åˆ¶

2. **é˜¶æ®µä¿¡å·ä¸ç¨³å®š**: å·¥ä¸šç¯å¢ƒå¯èƒ½äº§ç”ŸæŠ–åŠ¨
   - è§£å†³æ–¹æ¡ˆ: é‡‡ç”¨ç±»ä¼¼åˆ°é‡ä¿¡å·çš„é˜²æŠ–è®¾è®¡

3. **èµ„æºå ç”¨**: é¢‘ç¹è¯»å–å¯èƒ½å¢åŠ é€šä¿¡è´Ÿæ‹…
   - è§£å†³æ–¹æ¡ˆ: å¯ä»¥é™ä½é‡‡æ ·é¢‘ç‡ï¼Œæˆ–é‡‡ç”¨æ¡ä»¶è§¦å‘å¼é‡‡æ ·

### å»ºè®®å®æ–½æ­¥éª¤

1. **ä¿¡å·éªŒè¯**: å¼€å‘ä¸´æ—¶å·¥å…·éªŒè¯å„é˜¶æ®µMåœ°å€ä¿¡å·æ­£ç¡®æ€§
2. **åŸºç¡€ç›‘æµ‹**: å®ç°ä¿¡å·è¯»å–å’Œè®°å½•ä½†ä¸å±•ç¤º
3. **æ•°æ®ç»“æ„æ‰©å±•**: ä¿®æ”¹`EnhancedPackagingRecord`åŠ å…¥é˜¶æ®µæ—¶é—´
4. **UIå±•ç¤º**: åœ¨ç”Ÿäº§ç•Œé¢å¢åŠ é˜¶æ®µæ—¶é—´æ˜¾ç¤º
5. **æ•°æ®åˆ†æ**: å¯¹é˜¶æ®µæ—¶é—´è¿›è¡Œç»Ÿè®¡å’Œä¼˜åŒ–å»ºè®®

### ç»“è®º

æ·»åŠ é˜¶æ®µä¿¡å·ç›‘æ§æ˜¯ä¸€ä¸ªä»·å€¼é«˜ã€é£é™©ä½çš„åŠŸèƒ½å¢å¼ºï¼Œé€šè¿‡å¤ç”¨ç°æœ‰çš„ä¿¡å·ç›‘æµ‹æœºåˆ¶ï¼Œå¯ä»¥ä»¥è¾ƒä½çš„å¼€å‘æˆæœ¬è·å¾—é«˜ä»·å€¼çš„ç”Ÿäº§æ•°æ®ã€‚æ­¤åŠŸèƒ½å°†ä¸ºä¼˜åŒ–é…æ–™å‚æ•°æä¾›æ›´ç²¾ç¡®çš„æ•°æ®åŸºç¡€ï¼Œèƒ½æ˜¾è‘—æå‡ç³»ç»Ÿçš„ç²¾åº¦å’Œæ•ˆç‡ã€‚å»ºè®®é‡‡ç”¨æ¸è¿›å¼å¼€å‘æ–¹å¼ï¼Œå…ˆå®ç°åŸºç¡€ç›‘æµ‹åŠŸèƒ½ï¼Œå†æ‰©å±•ä¸ºå…¨åŠŸèƒ½åˆ†æå·¥å…·ã€‚ 

## é˜¶æ®µä¿¡å·ç›‘æ§åŠŸèƒ½å®ç°è¿›åº¦ (2023-07-06)

ä»Šå¤©å·²å®Œæˆé˜¶æ®µä¿¡å·ç›‘æ§åŠŸèƒ½çš„æ ¸å¿ƒå®ç°éƒ¨åˆ†ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š

### 1. é€šä¿¡æ¨¡å—æ‰©å±•
- å·²åœ¨`CommunicationManager`ç±»ä¸­æ·»åŠ `read_hopper_phase_signals`æ–¹æ³•ï¼Œç”¨äºè¯»å–æŒ‡å®šæ–™æ–—çš„ä¸‰ä¸ªé˜¶æ®µä¿¡å·ï¼ˆå¿«åŠ ã€æ…¢åŠ ã€ç²¾åŠ ï¼‰
- ä¿¡å·åœ°å€æ˜ å°„æ–¹å¼é‡‡ç”¨äº†åŸºå€+åç§»é‡çš„æ–¹å¼ï¼Œä¾¿äºåç»­è°ƒæ•´

```python
def read_hopper_phase_signals(self, hopper_index: int, unit: int = 1) -> Dict[str, bool]:
    """è¯»å–æŒ‡å®šæ–™æ–—çš„å„é˜¶æ®µä¿¡å·(å¿«åŠ ã€æ…¢åŠ ã€ç²¾åŠ )
    
    Args:
        hopper_index (int): æ–™æ–—ç´¢å¼•(1-6)
        unit (int, optional): ä»ç«™åœ°å€ï¼Œé»˜è®¤ä¸º1
        
    Returns:
        Dict[str, bool]: åŒ…å«å„é˜¶æ®µä¿¡å·çŠ¶æ€çš„å­—å…¸ï¼Œå¦‚æœè¯»å–å¤±è´¥åˆ™ç›¸åº”å€¼ä¸ºFalse
    """
    # çœç•¥å®ç°ç»†èŠ‚...
```

### 2. æ•°æ®ç»“æ„æ‰©å±•
- å·²ä¿®æ”¹`FeedingRecord`æ•°æ®ç±»ï¼Œåœ¨`process_data`å­—å…¸ä¸­å¢åŠ äº†`phase_times`å­—æ®µï¼Œç”¨äºå­˜å‚¨å„é˜¶æ®µæ—¶é—´
- ç›¸å…³ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š

```python
process_data: Dict[str, Any] = field(default_factory=lambda: {
    # å…¶ä»–å­—æ®µ...
    "phase_times": {
        "fast_feeding": 0.0,   # å¿«åŠ ä¿¡å·æ—¶é—´(ç§’)
        "slow_feeding": 0.0,   # æ…¢åŠ ä¿¡å·æ—¶é—´(ç§’)
        "fine_feeding": 0.0,   # ç²¾åŠ ä¿¡å·æ—¶é—´(ç§’)
    }
})
```

### 3. æ§åˆ¶æµç¨‹æ‰©å±•
- å·²ä¿®æ”¹`_real_packaging_with_micro_adjustment`æ–¹æ³•ï¼Œæ·»åŠ é˜¶æ®µä¿¡å·ç›‘æµ‹å’Œæ—¶é—´è®°å½•é€»è¾‘
- å®ç°äº†é˜¶æ®µåˆ‡æ¢æ£€æµ‹ã€é˜¶æ®µè€—æ—¶è®¡ç®—å’Œæ—¥å¿—è®°å½•
- ç¡®ä¿åœ¨åŒ…è£…ç»“æŸæ—¶è®°å½•å’Œä¿å­˜äº†å®Œæ•´çš„é˜¶æ®µæ—¶é—´ä¿¡æ¯

### 4. æ•°æ®åˆ†æä¸å¯è§†åŒ–
- åˆ›å»ºäº†`PhaseTimesAnalyzer`å·¥å…·ç±»ï¼Œç”¨äºåˆ†æé˜¶æ®µæ—¶é—´æ•°æ®
- å¼€å‘äº†`phase_times_chart.html`æ¨¡æ¿ï¼Œç”¨äºç”Ÿæˆé˜¶æ®µæ—¶é—´åˆ†ææŠ¥å‘Š
- æŠ¥å‘ŠåŒ…å«å„é˜¶æ®µæ—¶é—´çš„ç»Ÿè®¡æ•°æ®ã€è¶‹åŠ¿å›¾è¡¨å’Œç‰©æ–™å¯¹æ¯”åˆ†æ

### 5. æ•°æ®ä¿å­˜é›†æˆ
- å·²ä¿®æ”¹`_run_production`æ–¹æ³•ï¼Œæ·»åŠ å¯¹é˜¶æ®µæ—¶é—´æ•°æ®çš„ä¿å­˜
- é€šè¿‡å‚æ•°ä¼ é€’æ–¹å¼ï¼Œå°†é˜¶æ®µæ—¶é—´æ•°æ®ä¿å­˜åˆ°æ•°æ®ä»“åº“ä¸­

### åç»­è®¡åˆ’

ä¸‹ä¸€æ­¥å·¥ä½œé‡ç‚¹å°†æ˜¯ï¼š

1. **ä¿¡å·åœ°å€éªŒè¯ä¸è°ƒæ•´**ï¼šç¡®è®¤å®é™…PLCä¸­å„é˜¶æ®µä¿¡å·çš„ç¡®åˆ‡åœ°å€
2. **UIç•Œé¢é›†æˆ**ï¼šåœ¨ç”Ÿäº§ç•Œé¢æ·»åŠ é˜¶æ®µæ—¶é—´æ˜¾ç¤ºå’Œè¶‹åŠ¿å›¾è¡¨
3. **é˜¶æ®µæ—¶é—´åˆ†ææŠ¥å‘Š**ï¼šå®Œå–„æŠ¥å‘Šç”ŸæˆåŠŸèƒ½ï¼Œå¢åŠ æ›´å¤šç»´åº¦çš„åˆ†æ
4. **å‚æ•°ä¼˜åŒ–å»ºè®®**ï¼šåŸºäºé˜¶æ®µæ—¶é—´æ•°æ®ï¼Œä¸ºä¸åŒç‰©æ–™æä¾›å‚æ•°ä¼˜åŒ–å»ºè®®

è¿™äº›åŠŸèƒ½çš„å®ç°å°†è¿›ä¸€æ­¥æå‡ç³»ç»Ÿçš„æ™ºèƒ½åŒ–ç¨‹åº¦ï¼Œä½¿æ“ä½œäººå‘˜èƒ½å¤Ÿæ›´ç²¾ç¡®åœ°è°ƒæ•´å‚æ•°ï¼Œæé«˜ç”Ÿäº§æ•ˆç‡ã€‚ 

## ç³»ç»Ÿä¼˜åŒ–è®¨è®ºè®°å½• (2023-07-07)

é€šè¿‡å¯¹å¯¼å‡ºæ•°æ®çš„åˆ†æï¼Œæˆ‘ä»¬å‘ç°ç³»ç»Ÿä»ç„¶å­˜åœ¨ä»¥ä¸‹é—®é¢˜éœ€è¦è§£å†³ï¼š

### 1. é˜¶æ®µæ—¶é—´æ•°æ®æœªé‡‡é›†é—®é¢˜

**ç°çŠ¶**ï¼š
- å¯¼å‡ºçš„æ•°æ®ä¸­å¿«åŠ æ—¶é—´ã€æ…¢åŠ æ—¶é—´ã€åˆ‡æ¢ç‚¹é‡é‡å’Œç¨³å®šæ—¶é—´å…¨éƒ¨ä¸º0
- è™½ç„¶ä¿®å¤äº†æ•°æ®ç»“æ„å’Œä¿å­˜æœºåˆ¶ï¼Œä½†å®é™…é‡‡é›†åŠŸèƒ½å¯èƒ½æœªæ­£ç¡®å®ç°
- ä»å¯¼å‡ºçš„CSVæ ¼å¼æ¥çœ‹ï¼Œæ‰€æœ‰æ ·æœ¬çš„é˜¶æ®µæ—¶é—´å‡ä¸º0ï¼Œè¡¨æ˜è¿™æ˜¯ç³»ç»Ÿæ€§é—®é¢˜

**æ•°æ®æµè½¬åˆ†æ**ï¼š
1. **æ•°æ®æ¥æº**ï¼šé˜¶æ®µæ—¶é—´åº”ç”±`_real_packaging_with_micro_adjustment`æˆ–`_simulate_packaging_with_micro_adjustment`å‡½æ•°æµ‹é‡å’Œè®°å½•
2. **æ•°æ®å¤„ç†**ï¼šè®°å½•åˆ°çš„æ—¶é—´æ•°æ®åº”å­˜å‚¨åœ¨`phase_times`å­—å…¸ä¸­
3. **æ•°æ®ä¼ é€’**ï¼šé€šè¿‡`package_data`å­—å…¸ä»ç”Ÿäº§å‡½æ•°ä¼ é€’åˆ°`_run_production`
4. **æ•°æ®å­˜å‚¨**ï¼šæœ€ç»ˆé€šè¿‡`save_packaging_record`ä¿å­˜åˆ°æ•°æ®åº“

**å¯èƒ½çš„é—®é¢˜ç‚¹**ï¼ˆæŒ‰æ£€æŸ¥ä¼˜å…ˆçº§ï¼‰ï¼š
1. **é‡‡é›†å‡½æ•°æœªå®ç°**ï¼šæ£€æŸ¥`_real_packaging_with_micro_adjustment`ä¸­æ˜¯å¦å®é™…æµ‹é‡äº†å„é˜¶æ®µæ—¶é—´
   ```python
   # åº”è¯¥åœ¨è¯¥å‡½æ•°ä¸­æ‰¾åˆ°ç±»ä¼¼è¿™æ ·çš„ä»£ç :
   phase_start_time = time.time()
   # æŸä¸ªé˜¶æ®µçš„ä»£ç ...
   phase_times["fast_feeding"] = time.time() - phase_start_time
   ```

2. **é‡‡é›†å‡½æ•°å®ç°ä¸æ­£ç¡®**ï¼šæ£€æŸ¥ä¿¡å·åˆ¤æ–­é€»è¾‘æ˜¯å¦æœ‰è¯¯
   ```python
   # æ£€æŸ¥é˜¶æ®µåˆ¤æ–­é€»è¾‘æ˜¯å¦æ­£ç¡®:
   if current_weight < switching_weight:
       current_phase = "fast_feeding"
   elif current_weight < target_weight - fine_feeding_threshold:
       current_phase = "slow_feeding"
   else:
       current_phase = "fine_feeding"
   ```

3. **æ•°æ®æœªæ­£ç¡®ä¼ é€’**ï¼šæ£€æŸ¥è¿”å›å€¼æ ¼å¼
   ```python
   # å‡½æ•°è¿”å›å€¼åº”è¯¥æ˜¯è¿™æ ·çš„:
   return weight, {"phase_times": phase_times}
   
   # è€Œä¸æ˜¯:
   return weight
   ```

4. **æ•°æ®å­˜å‚¨æ—¶ä¸¢å¤±**ï¼šæ£€æŸ¥`_run_production`ä¸­çš„æå–é€»è¾‘
   ```python
   # åº”è¯¥æœ‰ç±»ä¼¼è¿™æ ·çš„ä»£ç :
   weight, package_data = self._real_packaging_with_micro_adjustment(...)
   phase_times = package_data.get("phase_times", {})
   ```

**å…·ä½“æ£€æŸ¥æ­¥éª¤**ï¼š
1. åœ¨`_real_packaging_with_micro_adjustment`å’Œ`_simulate_packaging_with_micro_adjustment`å¼€å¤´æ·»åŠ ä¸´æ—¶æ—¥å¿—
   ```python
   logger.info("å¼€å§‹æ‰§è¡ŒåŒ…è£…è¿‡ç¨‹ï¼Œå‡†å¤‡æµ‹é‡é˜¶æ®µæ—¶é—´")
   phase_times = {"fast_feeding": 0, "slow_feeding": 0, "fine_feeding": 0}
   ```

2. åœ¨å„é˜¶æ®µåˆ‡æ¢ç‚¹æ·»åŠ æ—¥å¿—è®°å½•
   ```python
   logger.info(f"é˜¶æ®µåˆ‡æ¢: {previous_phase} -> {current_phase}, è€—æ—¶: {phase_duration:.2f}ç§’")
   phase_times[previous_phase] = phase_duration
   ```

3. åœ¨å‡½æ•°ç»“æŸå‰è®°å½•å®Œæ•´çš„é˜¶æ®µæ—¶é—´
   ```python
   logger.info(f"åŒ…è£…å®Œæˆï¼Œé˜¶æ®µæ—¶é—´: {phase_times}")
   ```

4. åœ¨`_run_production`ä¸­æ·»åŠ æ—¥å¿—æ£€æŸ¥æ¥æ”¶åˆ°çš„æ•°æ®
   ```python
   logger.info(f"æ¥æ”¶åˆ°åŒ…è£…æ•°æ®: weight={weight}, data={package_data}")
   ```

**éªŒè¯æ–¹æ¡ˆ**ï¼š
åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•è„šæœ¬`verify_phase_times.py`ï¼Œç›´æ¥è°ƒç”¨é˜¶æ®µæ—¶é—´æµ‹é‡å‡½æ•°å¹¶è¾“å‡ºç»“æœï¼ŒéªŒè¯å…¶å·¥ä½œæ˜¯å¦æ­£ç¡®ï¼š
```python
def test_phase_time_measurement():
    """æµ‹è¯•é˜¶æ®µæ—¶é—´æµ‹é‡åŠŸèƒ½"""
    # åˆ›å»ºä¸´æ—¶æ§åˆ¶å™¨å®ä¾‹
    controller = AdaptiveControllerWithMicroAdjustment()
    
    # è°ƒç”¨æ¨¡æ‹ŸåŒ…è£…å‡½æ•°
    weight, data = controller._simulate_packaging_with_micro_adjustment(100.0)
    
    # æ£€æŸ¥è¿”å›çš„æ•°æ®ç»“æ„
    print(f"è¿”å›é‡é‡: {weight}g")
    print(f"è¿”å›æ•°æ®: {data}")
    
    # æ£€æŸ¥é˜¶æ®µæ—¶é—´
    if "phase_times" in data:
        phase_times = data["phase_times"]
        print(f"å¿«åŠ æ—¶é—´: {phase_times.get('fast_feeding', 0):.2f}ç§’")
        print(f"æ…¢åŠ æ—¶é—´: {phase_times.get('slow_feeding', 0):.2f}ç§’")
        print(f"ç²¾åŠ æ—¶é—´: {phase_times.get('fine_feeding', 0):.2f}ç§’")
    else:
        print("é”™è¯¯: æœªåŒ…å«é˜¶æ®µæ—¶é—´æ•°æ®!")

if __name__ == "__main__":
    test_phase_time_measurement()
```

### 2. å‚æ•°ä¸åŒ¹é…é—®é¢˜

**ç°çŠ¶**ï¼š
- è¡¨æ˜¾ç¤ºå¿«åŠ æå‰é‡21.82å…‹ï¼Œå®é™…æœºå™¨æ˜¾ç¤º40å…‹
- è¡¨æ˜¾ç¤ºè½å·®å€¼0.73å…‹ï¼Œå®é™…åº”ä¸º1.6å…‹
- å‚æ•°æ˜¾ç¤ºä¸å®é™…æ§åˆ¶ä¸ä¸€è‡´ï¼Œå¯¼è‡´æ•°æ®åˆ†æå¤±çœŸ

**é—®é¢˜å®šä½æµç¨‹**ï¼š

1. **å‚æ•°ä¼ é€’è·¯å¾„å›¾**ï¼š
   ```
   UIç•Œé¢å‚æ•°è¾“å…¥ 
   â†’ SmartProductionTab._setup_control_panel() è®¾ç½®UIé»˜è®¤å€¼
   â†’ SmartProductionTab._start_production() ä»UIè·å–å‚æ•°å€¼
   â†’ AdaptiveController.set_parameters() è®¾ç½®æ§åˆ¶å™¨å‚æ•°
   â†’ AdaptiveController.get_current_parameters() è¯»å–ç”¨äºä¿å­˜çš„å‚æ•°
   â†’ LearningDataRepository.save_packaging_record() ä¿å­˜å‚æ•°åˆ°æ•°æ®åº“
   ```

2. **é‡ç‚¹æ£€æŸ¥æ–‡ä»¶åŠå‡½æ•°**ï¼š
   - `src/ui/smart_production_tab.py`: `_setup_control_panel()`, `_start_production()`
   - `src/adaptive_algorithm/adaptive_controller_with_micro_adjustment.py`: `set_parameters()`, `get_current_parameters()`
   - `src/adaptive_algorithm/learning_system/learning_data_repo.py`: `save_packaging_record()`

3. **å¯èƒ½çš„é—®é¢˜æ ¹æº**ï¼š
   - å•ä½è½¬æ¢é—®é¢˜ï¼ˆå¦‚å…‹ä¸ç™¾åˆ†æ¯”çš„æ··æ·†ï¼‰
   - ç•Œé¢æ˜¾ç¤ºå€¼ä¸å®é™…ä¼ é€’å€¼ä¸ä¸€è‡´
   - æ§åˆ¶å™¨å†…éƒ¨ä½¿ç”¨å€¼ä¸ä¿å­˜åˆ°æ•°æ®åº“çš„å€¼ä¸åŒ
   - å¯èƒ½å­˜åœ¨æŸä¸ªå‚æ•°å¤„ç†å‡½æ•°å¯¹æ•°æ®è¿›è¡Œäº†ç¼©æ”¾æˆ–æ ¼å¼åŒ–

**å‚æ•°ä¸€è‡´æ€§æ£€æŸ¥ä»£ç **ï¼š
```python
def verify_parameter_consistency():
    """éªŒè¯å„ç¯èŠ‚å‚æ•°ä¸€è‡´æ€§"""
    # 1. è·å–UIç•Œé¢æ˜¾ç¤ºçš„å‚æ•°å€¼
    ui_params = {
        "coarse_advance": float(self.coarse_advance_input.text()),
        "fine_advance": float(self.fine_advance_input.text())
    }
    print(f"UIç•Œé¢å‚æ•°: {ui_params}")
    
    # 2. è·å–æ§åˆ¶å™¨å€¼
    controller_params = self.controller.get_current_parameters()
    print(f"æ§åˆ¶å™¨å†…éƒ¨å‚æ•°: {controller_params}")
    
    # 3. è®°å½•å·®å¼‚
    for key in ui_params:
        if key in controller_params:
            diff = abs(ui_params[key] - controller_params[key])
            if diff > 0.01:  # å…è®¸0.01çš„è¯¯å·®
                print(f"å‚æ•°'{key}'ä¸ä¸€è‡´: UI={ui_params[key]}, æ§åˆ¶å™¨={controller_params[key]}")
```

**å®æ–½ä¿®å¤çš„å…·ä½“æ­¥éª¤**ï¼š

1. **æ·»åŠ å‚æ•°é—®é¢˜è¯Šæ–­å‡½æ•°**åˆ°`SmartProductionTab`ç±»ï¼š
```python
def _debug_parameter_values(self):
    """è¯Šæ–­å‚æ•°ä¼ é€’é—®é¢˜"""
    # è·å–UIå€¼
    ui_coarse_advance = float(self.coarse_advance_input.text())
    ui_fine_advance = float(self.fine_advance_input.text())
    
    # è·å–æ§åˆ¶å™¨å€¼
    controller_coarse_advance = self.controller.coarse_advance
    controller_fine_advance = self.controller.fine_advance
    
    # è·å–å³å°†ä¿å­˜çš„å‚æ•°
    save_params = self.controller.get_current_parameters()
    
    # è®°å½•æ—¥å¿—
    logger.info(f"å‚æ•°å¯¹æ¯” - UIå¿«åŠ æå‰é‡: {ui_coarse_advance}, æ§åˆ¶å™¨: {controller_coarse_advance}, ä¿å­˜å€¼: {save_params.get('coarse_advance')}")
    logger.info(f"å‚æ•°å¯¹æ¯” - UIè½å·®å€¼: {ui_fine_advance}, æ§åˆ¶å™¨: {controller_fine_advance}, ä¿å­˜å€¼: {save_params.get('fine_advance')}")
```

2. **åˆ›å»º`debug_parameters.py`è„šæœ¬**ï¼Œç›´æ¥æ£€æŸ¥æ•°æ®åº“ä¸­çš„å‚æ•°ä¸æ§åˆ¶å™¨å‚æ•°:
```python
def compare_db_and_controller_params():
    """æ¯”è¾ƒæ•°æ®åº“å‚æ•°ä¸æ§åˆ¶å™¨å‚æ•°"""
    # ä»æ•°æ®åº“è·å–æœ€è¿‘çš„è®°å½•
    data_repo = LearningDataRepository()
    recent_records = data_repo.get_recent_records(limit=5)
    
    # åˆ›å»ºæ§åˆ¶å™¨å®ä¾‹
    controller = AdaptiveControllerWithMicroAdjustment()
    
    # è®¾ç½®æ§åˆ¶å™¨å‚æ•°(æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒçš„å®é™…å‚æ•°)
    controller.coarse_advance = 40.0  # å®é™…ä½¿ç”¨çš„å¿«åŠ æå‰é‡
    controller.fine_advance = 1.6     # å®é™…ä½¿ç”¨çš„è½å·®å€¼
    
    # è·å–æ§åˆ¶å™¨å‚æ•°(ç”¨äºä¿å­˜)
    controller_params = controller.get_current_parameters()
    
    # æ¯”è¾ƒå‚æ•°
    print("æ§åˆ¶å™¨å‚æ•°(å†…éƒ¨ä½¿ç”¨å€¼):")
    print(f"å¿«åŠ æå‰é‡: {controller.coarse_advance}")
    print(f"è½å·®å€¼: {controller.fine_advance}")
    
    print("\næ§åˆ¶å™¨å‚æ•°(get_current_parametersè¿”å›å€¼):")
    print(f"å¿«åŠ æå‰é‡: {controller_params.get('coarse_advance')}")
    print(f"è½å·®å€¼: {controller_params.get('fine_advance')}")
    
    print("\næ•°æ®åº“ä¸­æœ€è¿‘çš„å‚æ•°:")
    for i, record in enumerate(recent_records):
        params = record['parameters']
        print(f"è®°å½• {i+1} - å¿«åŠ æå‰é‡: {params.get('coarse_advance')}, è½å·®å€¼: {params.get('fine_advance')}")
```

3. **å‚æ•°æ ¼å¼åŒ–æ£€æŸ¥**ï¼š
å®¡æŸ¥`get_current_parameters`æ–¹æ³•ä¸­æ˜¯å¦æœ‰ä¸å¿…è¦çš„æ ¼å¼åŒ–æˆ–è½¬æ¢é€»è¾‘ï¼š
```python
# æ‰¾å‡ºç±»ä¼¼è¿™æ ·å¯èƒ½å¯¼è‡´é—®é¢˜çš„ä»£ç :
def get_current_parameters(self):
    return {
        # è¿™é‡Œå¯èƒ½æœ‰é—®é¢˜çš„è½¬æ¢ä»£ç 
        "coarse_advance": self.coarse_advance / 1.83,  # é™¤ä»¥æŸä¸ªç³»æ•°
        "fine_advance": self.fine_advance * 0.456,     # ä¹˜ä»¥æŸä¸ªç³»æ•°
    }

# åº”è¯¥æ”¹ä¸ºå•çº¯è¿”å›å€¼:
def get_current_parameters(self):
    return {
        "coarse_advance": self.coarse_advance,  # ç›´æ¥è¿”å›åŸå€¼
        "fine_advance": self.fine_advance,
    }
```

**é¢„æœŸä¿®å¤ç»“æœ**ï¼š
- æ‰¾å‡ºå¹¶ä¿®æ­£å‚æ•°ä¸ä¸€è‡´çš„æ ¹æœ¬åŸå› 
- ç¡®ä¿UIæ˜¾ç¤ºã€æ§åˆ¶å™¨ä½¿ç”¨å’Œæ•°æ®åº“ä¿å­˜çš„å‚æ•°å®Œå…¨ä¸€è‡´
- å¯¼å‡ºæ•°æ®èƒ½å¤Ÿå‡†ç¡®åæ˜ å®é™…ä½¿ç”¨çš„å‚æ•°å€¼ï¼Œä¾¿äºåˆ†æä¼˜åŒ–

### 4. ç‰©æ–™æ¨èäº¤äº’ä¼˜åŒ–

**ç°çŠ¶**ï¼š
- æ¯æ¬¡åŒ…è£…å‘¨æœŸç»“æŸéƒ½ä¼šå¼¹å‡ºç‰©æ–™å‚æ•°æ¨èè¯¢é—®
- è¿‡äºé¢‘ç¹çš„å¼¹çª—å¹²æ‰°äº†æ“ä½œæµç¨‹
- å½“å‰è¯¢é—®æ˜¯æ— æ¡ä»¶è§¦å‘çš„ï¼Œä¸è€ƒè™‘å‚æ•°è´¨é‡

**å…·ä½“ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

1. **æ¡ä»¶è§¦å‘è¯¢é—®æœºåˆ¶**ï¼š
```python
def _should_prompt_save_parameters(self, error, target_weight, cycle_count):
    """å†³å®šæ˜¯å¦åº”è¯¥æç¤ºä¿å­˜å‚æ•°"""
    # è®¡ç®—ç›¸å¯¹è¯¯å·®ç‡
    error_rate = abs(error / target_weight * 100)
    
    # æ¡ä»¶1: è¯¯å·®ç‡ä½äºé¢„è®¾é˜ˆå€¼(è‰¯å¥½åŒ…è£…è´¨é‡)
    quality_threshold_met = error_rate < 1.5  # è¯¯å·®ä½äº1.5%
    
    # æ¡ä»¶2: è‡³å°‘å®Œæˆä¸€å®šæ•°é‡çš„åŒ…è£…
    min_cycles_completed = cycle_count >= 3  # è‡³å°‘å®Œæˆ3æ¬¡åŒ…è£…
    
    # æ¡ä»¶3: è‡ªä¸Šæ¬¡è¯¢é—®å·²ç»ç»è¿‡è¶³å¤Ÿçš„å‘¨æœŸ
    cycles_since_last_prompt = self.cycles_since_last_param_prompt
    prompt_interval_met = cycles_since_last_prompt >= 10  # æ¯10æ¬¡æœ€å¤šè¯¢é—®ä¸€æ¬¡
    
    # æ¡ä»¶4: å‚æ•°ä¸ä¸Šæ¬¡ä¿å­˜çš„å‚æ•°æœ‰æ˜¾è‘—ä¸åŒ
    params_changed = False
    if self.controller.has_material_parameters(self.current_material_type):
        saved_params = self.controller.get_material_parameters(self.current_material_type)
        current_params = self.controller.get_current_parameters()
        
        # è®¡ç®—å…³é”®å‚æ•°çš„å˜åŒ–ç™¾åˆ†æ¯”
        for key in ["coarse_advance", "fine_advance"]:
            if key in saved_params and key in current_params:
                change_percent = abs((current_params[key] - saved_params[key]) / saved_params[key] * 100)
                if change_percent > 10:  # å‚æ•°å˜åŒ–è¶…è¿‡10%
                    params_changed = True
                    break
    else:
        # å¦‚æœè¿™æ˜¯æ–°ç‰©æ–™(æ²¡æœ‰ä¿å­˜çš„å‚æ•°)ï¼Œåˆ™è§†ä¸ºå‚æ•°å˜åŒ–
        params_changed = True
    
    # æ»¡è¶³æ‰€æœ‰æ¡ä»¶æ—¶æ‰æç¤º
    should_prompt = (
        quality_threshold_met and 
        min_cycles_completed and 
        (prompt_interval_met or params_changed)
    )
    
    if should_prompt:
        # é‡ç½®è¯¢é—®é—´éš”è®¡æ•°å™¨
        self.cycles_since_last_param_prompt = 0
    else:
        # å¢åŠ è®¡æ•°å™¨
        self.cycles_since_last_param_prompt += 1
    
    return should_prompt
```

2. **éä¾µå…¥å¼é€šçŸ¥ç•Œé¢**ï¼š
```python
def _show_non_intrusive_notification(self, message, action_callback=None, duration=5000):
    """æ˜¾ç¤ºéä¾µå…¥å¼é€šçŸ¥ï¼Œä¸é˜»æ–­å·¥ä½œæµ"""
    # åˆ›å»ºé€šçŸ¥å®¹å™¨
    notification = QFrame(self)
    notification.setFrameShape(QFrame.StyledPanel)
    notification.setStyleSheet("""
        QFrame {
            background-color: #f0f8ff;
            border: 1px solid #a0c8f0;
            border-radius: 4px;
        }
    """)
    
    # åˆ›å»ºå¸ƒå±€
    layout = QVBoxLayout(notification)
    
    # æ·»åŠ æ¶ˆæ¯æ ‡ç­¾
    msg_label = QLabel(message, notification)
    msg_label.setWordWrap(True)
    layout.addWidget(msg_label)
    
    # æ·»åŠ æŒ‰é’®å®¹å™¨
    btn_container = QWidget(notification)
    btn_layout = QHBoxLayout(btn_container)
    btn_layout.setContentsMargins(0, 0, 0, 0)
    
    # æ·»åŠ æ“ä½œæŒ‰é’®
    if action_callback:
        action_btn = QPushButton("ä¿å­˜å‚æ•°", btn_container)
        action_btn.clicked.connect(action_callback)
        action_btn.setStyleSheet("background-color: #4CAF50; color: white;")
        btn_layout.addWidget(action_btn)
    
    # æ·»åŠ å…³é—­æŒ‰é’®
    close_btn = QPushButton("å…³é—­", btn_container)
    close_btn.clicked.connect(notification.deleteLater)
    btn_layout.addWidget(close_btn)
    
    layout.addWidget(btn_container)
    
    # æ”¾ç½®åœ¨ä¸»çª—å£å³ä¸‹è§’
    self.layout().addWidget(notification, 0, Qt.AlignBottom | Qt.AlignRight)
    
    # è®¾ç½®è‡ªåŠ¨æ¶ˆå¤±
    if duration > 0:
        QTimer.singleShot(duration, notification.deleteLater)
    
    return notification
```

3. **æ™ºèƒ½æ‰¹é‡ç¡®è®¤æœºåˆ¶**ï¼š
```python
class ParameterSavingSession:
    """å‚æ•°ä¿å­˜ä¼šè¯ï¼Œç®¡ç†å¤šä¸ªå‘¨æœŸå†…çš„å‚æ•°ä¿å­˜é€»è¾‘"""
    
    def __init__(self, max_cycles=10):
        self.max_cycles = max_cycles  # æœ€å¤§æ”¶é›†å‘¨æœŸæ•°
        self.current_cycle = 0
        self.collected_data = []  # æ”¶é›†çš„å‚æ•°å’Œæ€§èƒ½æ•°æ®
        self.is_active = False
        
    def start_session(self):
        """å¼€å§‹æ–°çš„æ”¶é›†ä¼šè¯"""
        self.current_cycle = 0
        self.collected_data = []
        self.is_active = True
        
    def add_cycle_data(self, params, performance):
        """æ·»åŠ ä¸€ä¸ªå‘¨æœŸçš„æ•°æ®"""
        if not self.is_active:
            return False
            
        self.collected_data.append({
            "params": params.copy(),
            "performance": performance.copy()
        })
        
        self.current_cycle += 1
        return self.current_cycle >= self.max_cycles
        
    def get_best_parameters(self):
        """è·å–ä¼šè¯ä¸­æ€§èƒ½æœ€ä½³çš„å‚æ•°"""
        if not self.collected_data:
            return None
            
        # æ ¹æ®è¯¯å·®æ’åºï¼Œé€‰æ‹©è¯¯å·®æœ€å°çš„å‚æ•°
        sorted_data = sorted(self.collected_data, 
                           key=lambda x: abs(x["performance"]["error"]))
        
        return sorted_data[0]["params"]
```

4. **æ”¹è¿›åçš„å‚æ•°ä¿å­˜æµç¨‹**ï¼š
```python
def _run_production(self):
    """æ”¹è¿›åçš„ç”Ÿäº§è¿è¡Œå‡½æ•°ï¼ŒåŒ…å«æ™ºèƒ½å‚æ•°ä¿å­˜é€»è¾‘"""
    # ... ç°æœ‰ä»£ç  ...
    
    # å¤„ç†åŒ…è£…å®Œæˆåçš„é€»è¾‘
    if result:
        # ... ç°æœ‰ç”Ÿäº§ç»“æœå¤„ç†ä»£ç  ...
        
        # æ”¶é›†å‚æ•°å’Œæ€§èƒ½æ•°æ®
        cycle_params = self.controller.get_current_parameters()
        cycle_performance = {
            "error": weight - target_weight,
            "error_rate": (weight - target_weight) / target_weight * 100,
            "packaging_time": production_time
        }
        
        # æ·»åŠ åˆ°å‚æ•°ä¼šè¯
        if not hasattr(self, 'param_saving_session'):
            self.param_saving_session = ParameterSavingSession(max_cycles=5)
            
        session_complete = self.param_saving_session.add_cycle_data(
            cycle_params, cycle_performance)
            
        # æ£€æŸ¥æ˜¯å¦åº”è¯¥æç¤ºä¿å­˜å‚æ•°
        if session_complete:
            best_params = self.param_saving_session.get_best_parameters()
            avg_error = sum(abs(d["performance"]["error"]) for d in self.param_saving_session.collected_data) / len(self.param_saving_session.collected_data)
            
            # åªæœ‰å½“è¯¯å·®è¾ƒå°æ—¶æ‰æç¤º
            if avg_error < target_weight * 0.02:  # è¯¯å·®å°äº2%
                # ä½¿ç”¨éä¾µå…¥å¼é€šçŸ¥è€Œéæ¨¡æ€å¯¹è¯æ¡†
                save_callback = lambda: self._save_material_parameters(
                    self.current_material_type, best_params)
                    
                self._show_non_intrusive_notification(
                    f"å‘ç°"{self.current_material_type}"çš„è‰¯å¥½å‚æ•°é…ç½®(å¹³å‡è¯¯å·®: {avg_error:.2f}g)ã€‚æ˜¯å¦ä¿å­˜?",
                    action_callback=save_callback
                )
            
            # é‡ç½®ä¼šè¯ï¼Œå‡†å¤‡ä¸‹ä¸€è½®æ”¶é›†
            self.param_saving_session.start_session()
```

5. **è®¾ç½®ç•Œé¢é›†æˆ**ï¼š

åœ¨è®¾ç½®ç•Œé¢æ·»åŠ å‚æ•°ä¿å­˜ç›¸å…³é€‰é¡¹ï¼Œä½¿ç”¨æˆ·èƒ½è‡ªå®šä¹‰äº¤äº’è¡Œä¸ºï¼š

```python
def _setup_parameter_saving_preferences(self, settings_tab):
    """è®¾ç½®å‚æ•°ä¿å­˜é¦–é€‰é¡¹"""
    group_box = QGroupBox("å‚æ•°ä¿å­˜è®¾ç½®", settings_tab)
    layout = QVBoxLayout(group_box)
    
    # åˆ›å»ºé€‰é¡¹
    self.auto_save_cb = QCheckBox("è‡ªåŠ¨è®°å½•è‰¯å¥½å‚æ•°(æ— éœ€ç¡®è®¤)")
    self.prompt_after_cycles_sb = QSpinBox()
    self.prompt_after_cycles_sb.setRange(1, 20)
    self.prompt_after_cycles_sb.setValue(5)
    self.error_threshold_sb = QDoubleSpinBox()
    self.error_threshold_sb.setRange(0.5, 5.0)
    self.error_threshold_sb.setValue(1.5)
    self.error_threshold_sb.setSuffix("%")
    
    # æ·»åŠ åˆ°å¸ƒå±€
    prompt_layout = QHBoxLayout()
    prompt_layout.addWidget(QLabel("æ¯å®Œæˆ"))
    prompt_layout.addWidget(self.prompt_after_cycles_sb)
    prompt_layout.addWidget(QLabel("ä¸ªå‘¨æœŸæ£€æŸ¥ä¸€æ¬¡å‚æ•°"))
    
    threshold_layout = QHBoxLayout()
    threshold_layout.addWidget(QLabel("å½“è¯¯å·®ä½äº"))
    threshold_layout.addWidget(self.error_threshold_sb)
    threshold_layout.addWidget(QLabel("æ—¶è®¤ä¸ºæ˜¯è‰¯å¥½å‚æ•°"))
    
    layout.addWidget(self.auto_save_cb)
    layout.addLayout(prompt_layout)
    layout.addLayout(threshold_layout)
    
    # æ·»åŠ åº”ç”¨æŒ‰é’®
    apply_btn = QPushButton("åº”ç”¨è®¾ç½®")
    apply_btn.clicked.connect(self._apply_parameter_saving_preferences)
    layout.addWidget(apply_btn)
    
    return group_box
```

**UIè®¾è®¡è‰å›¾**ï¼š

1. **éä¾µå…¥å¼é€šçŸ¥æ¡†**ï¼š
```
+----------------------------------+
| å‘ç°"å°éº¦ç²‰"çš„è‰¯å¥½å‚æ•°é…ç½®      |
| (å¹³å‡è¯¯å·®: 1.20g)ã€‚æ˜¯å¦ä¿å­˜?    |
|                                  |
| [ä¿å­˜å‚æ•°]           [å…³é—­]      |
+----------------------------------+
```

2. **å‚æ•°å†å²è®°å½•è§†å›¾**ï¼ˆåœ¨è®¾ç½®ç•Œé¢ï¼‰ï¼š
```
+--------------------------------------------------+
| ç‰©æ–™"å°éº¦ç²‰"çš„å‚æ•°å†å²                           |
+--------------------------------------------------+
| æ—¥æœŸ      | è¯¯å·®  | å¿«åŠ æå‰é‡ | è½å·®å€¼ | æ“ä½œ   |
+--------------------------------------------------+
| 2023/7/5  | 1.2g  | 38.5g      | 1.4g   | [åº”ç”¨] |
| 2023/7/4  | 1.8g  | 40.0g      | 1.6g   | [åº”ç”¨] |
| 2023/7/3  | 2.1g  | 42.5g      | 1.8g   | [åº”ç”¨] |
+--------------------------------------------------+
| [æ¯”è¾ƒé€‰ä¸­å‚æ•°]      [å¯¼å‡ºå‚æ•°]     [åˆ é™¤]        |
+--------------------------------------------------+
```

**é¢„æœŸæ”¹è¿›æ•ˆæœ**ï¼š
1. æç¤ºé¢‘ç‡å¤§å¹…é™ä½ï¼Œä»"æ¯æ¬¡åŒ…è£…åè¯¢é—®"å‡å°‘åˆ°"åªåœ¨å‚æ•°è¡¨ç°ä¼˜å¼‚æ—¶è¯¢é—®"
2. æ“ä½œæµç¨‹æ›´é¡ºç•…ï¼Œä¸å†é¢‘ç¹æ‰“æ–­ç”¨æˆ·æ“ä½œ
3. å‚æ•°ä¿å­˜æ›´æœ‰é’ˆå¯¹æ€§ï¼Œåªä¿å­˜çœŸæ­£æœ‰ä»·å€¼çš„å‚æ•°ç»„åˆ
4. ç”¨æˆ·æ‹¥æœ‰æ›´å¤šæ§åˆ¶æƒï¼Œå¯æ ¹æ®éœ€è¦è‡ªå®šä¹‰äº¤äº’æ–¹å¼

## å‚æ•°ç›‘æ§ä¸æºç æ’æ¡©æ–¹æ¡ˆ (2024-05-05)

### èƒŒæ™¯ä¸é—®é¢˜åˆ†æ

ç³»ç»Ÿå½“å‰å­˜åœ¨å‚æ•°è¯»å–æ˜¾ç¤ºä¸ä¸€è‡´å’Œé˜¶æ®µæ—¶é—´æœªè®°å½•çš„é—®é¢˜ï¼Œéœ€è¦é€šè¿‡æºç æ’æ¡©æ–¹å¼å®ç°å®æ—¶ç›‘æ§ã€‚æˆ‘ä»¬å‘ç°äº†ä»¥ä¸‹æ ¸å¿ƒé—®é¢˜ï¼š

1. **å‚æ•°ä¸åŒ¹é…é—®é¢˜**ï¼š
   - è¡¨æ˜¾ç¤ºå¿«åŠ æå‰é‡ä¸å®é™…æœºå™¨æ˜¾ç¤ºä¸ä¸€è‡´ï¼ˆè¡¨ç¤º21.82å…‹ï¼Œå®é™…ä¸º40å…‹ï¼‰
   - è¡¨æ˜¾ç¤ºè½å·®å€¼ä¸å®é™…ä¸ç¬¦ï¼ˆè¡¨ç¤º0.73å…‹ï¼Œå®é™…åº”ä¸º1.6å…‹ï¼‰
   - å‚æ•°æ˜¾ç¤ºä¸å®é™…æ§åˆ¶ä¸ä¸€è‡´ï¼Œå¯¼è‡´æ•°æ®åˆ†æå¤±çœŸ

2. **é˜¶æ®µæ—¶é—´æ•°æ®æœªé‡‡é›†é—®é¢˜**ï¼š
   - å¯¼å‡ºçš„æ•°æ®ä¸­å¿«åŠ æ—¶é—´ã€æ…¢åŠ æ—¶é—´å’Œç›¸å…³é˜¶æ®µæ•°æ®å…¨éƒ¨ä¸º0
   - è™½ç„¶å·²ä¿®å¤æ•°æ®ç»“æ„ï¼Œä½†å®é™…é‡‡é›†åŠŸèƒ½å¯èƒ½æœªæ­£ç¡®å®ç°

### æºç æ’æ¡©è®¾è®¡æ–¹æ¡ˆ

æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªéä¾µå…¥å¼çš„å†…å­˜å…±äº«ç›‘æ§æ–¹æ¡ˆï¼Œå…·ä½“åŒ…æ‹¬ä»¥ä¸‹ç»„ä»¶ï¼š

#### 1. å†…å­˜å…±äº«ç»“æ„ï¼ˆMonitoringDataHubï¼‰

```python
# æ ¸å¿ƒç›‘æ§æ•°æ®ç»“æ„
class MonitoringDataHub:
    """ç›‘æ§æ•°æ®ä¸­å¿ƒï¼Œä¿å­˜å®æ—¶ç›‘æ§æ•°æ®å¹¶æ”¯æŒå¤–éƒ¨è®¿é—®"""
    
    _instance = None
    _lock = threading.Lock()
    
    @classmethod
    def get_instance(cls):
        """å•ä¾‹æ¨¡å¼è·å–å®ä¾‹"""
        with cls._lock:
            if cls._instance is None:
                cls._instance = MonitoringDataHub()
            return cls._instance
    
    def __init__(self):
        # ä¿¡å·æ•°æ®
        self.signals_data = {
            "timestamp": time.time(),
            "fast_feeding": False,
            "slow_feeding": False,
            "fine_feeding": False
        }
        
        # å‚æ•°æ•°æ®
        self.parameters = {
            "plc": {
                "å¿«åŠ é€Ÿåº¦": 0,
                "æ…¢åŠ é€Ÿåº¦": 0,
                "å¿«åŠ æå‰é‡": 0,
                "è½å·®å€¼": 0
            },
            "controller": {
                "coarse_speed": 0,
                "fine_speed": 0,
                "coarse_advance": 0,
                "fine_advance": 0
            }
        }
        
        # é˜¶æ®µæ—¶é—´æ•°æ®
        self.phase_times = {
            "timestamp": time.time(),
            "fast_feeding": 0,
            "slow_feeding": 0,
            "fine_feeding": 0,
            "current_phase": None,
            "phase_start_time": None
        }
        
        # é‡é‡æ•°æ®
        self.weights = {
            "timestamp": time.time(),
            "current_weight": 0,
            "target_weight": 0
        }
```

#### 2. å…³é”®ä½ç½®æ’æ¡©ä»£ç 

ä»¥ä¸‹æ˜¯éœ€è¦åœ¨å„å…³é”®ä½ç½®æ·»åŠ çš„æºç æ’æ¡©ï¼š

##### é˜¶æ®µä¿¡å·è¯»å–æ’æ¡© (comm_manager.py)

```python
def read_hopper_phase_signals(self, hopper_index, slave_id=1):
    """è¯»å–æ–™æ–—é˜¶æ®µä¿¡å·å¹¶è®°å½•åˆ°ç›‘æ§ä¸­å¿ƒ"""
    try:
        result = original_read_hopper_phase_signals(hopper_index, slave_id)
        
        # æ’æ¡©ä»£ç ï¼šè®°å½•ä¿¡å·çŠ¶æ€
        from src.monitoring.shared_memory import MonitoringDataHub
        MonitoringDataHub.get_instance().update_signals({
            "fast_feeding": result.get("fast_feeding", False),
            "slow_feeding": result.get("slow_feeding", False),
            "fine_feeding": result.get("fine_feeding", False),
            "hopper_index": hopper_index
        })
        
        return result
    except Exception as e:
        logger.error(f"è¯»å–å¹¶è®°å½•é˜¶æ®µä¿¡å·å¤±è´¥: {e}")
        return {"fast_feeding": False, "slow_feeding": False, "fine_feeding": False}
```

##### PLCå‚æ•°è¯»å–æ’æ¡© (comm_manager.py)

```python
def read_parameters(self, slave_id=1):
    # åŸæœ‰ä»£ç ...
    
    # æ’æ¡©ä»£ç ï¼šè®°å½•PLCå‚æ•°
    from src.monitoring.shared_memory import MonitoringDataHub
    MonitoringDataHub.get_instance().update_parameters(
        plc_params={
            "å¿«åŠ é€Ÿåº¦": result.get("ç²—åŠ æ–™é€Ÿåº¦", [0])[0],
            "æ…¢åŠ é€Ÿåº¦": result.get("ç²¾åŠ æ–™é€Ÿåº¦", [0])[0],
            "å¿«åŠ æå‰é‡": result.get("ç²—åŠ æå‰é‡", [0])[0],
            "è½å·®å€¼": result.get("ç²¾åŠ æå‰é‡", [0])[0]
        }
    )
    
    return result
```

### å®æ–½è¿›åº¦ä¸è®¡åˆ’

å½“å‰å®æ–½è¿›åº¦ï¼š

1. **ä»£ç å¤‡ä»½å·²å®Œæˆ**ï¼š
   - åœ¨æ ¹ç›®å½•åˆ›å»ºäº†bf55æ–‡ä»¶å¤¹
   - å¼€å§‹å¤åˆ¶å…³é”®æ–‡ä»¶è¿›è¡Œå¤‡ä»½

2. **å¼€å‘ç¯å¢ƒå‡†å¤‡**ï¼š
   - å·²è®¾è®¡ç›‘æ§æ•°æ®å…±äº«ç±»ç»“æ„
   - å·²è®¾è®¡æ’æ¡©ç‚¹å’Œæ’æ¡©ä»£ç 
   - å·²å‡†å¤‡ç›‘æ§æ•°æ®è¯»å–è„šæœ¬

3. **ä¸‹ä¸€æ­¥è®¡åˆ’**ï¼š
   - å®Œæˆå¤‡ä»½æºä»£ç ï¼ˆsrcç›®å½•ä¸‹çš„å…³é”®æ–‡ä»¶ï¼‰
   - åˆ›å»ºç›‘æ§æ¨¡å—ç›®å½•ç»“æ„(`src/monitoring`)
   - å®ç°`shared_memory.py`æ–‡ä»¶
   - é€æ­¥æ·»åŠ æ’æ¡©ä»£ç åˆ°å…³é”®ä½ç½®
   - æµ‹è¯•ç›‘æ§æ•°æ®è¯»å–è„šæœ¬

### é¢„æœŸæˆæœ

å®æ–½å®Œæˆåï¼Œæˆ‘ä»¬é¢„æœŸå°†è·å¾—ä»¥ä¸‹æˆæœï¼š

1. **å‚æ•°ä¸€è‡´æ€§éªŒè¯**ï¼š
   - èƒ½å¤Ÿå®æ—¶ç›‘æµ‹PLCå‚æ•°å’Œæ§åˆ¶å™¨å‚æ•°
   - ç›´è§‚å‘ˆç°å‚æ•°å·®å¼‚ï¼Œå¸®åŠ©å®šä½ä¸ä¸€è‡´åŸå› 

2. **é˜¶æ®µæ—¶é—´æ•°æ®é‡‡é›†**ï¼š
   - å®Œæ•´è®°å½•å„é˜¶æ®µï¼ˆå¿«åŠ ã€æ…¢åŠ ã€ç²¾åŠ ï¼‰æŒç»­æ—¶é—´
   - ä¸ºåŒ…è£…å‘¨æœŸä¼˜åŒ–æä¾›æ•°æ®åŸºç¡€

3. **è¯Šæ–­æŠ¥å‘Š**ï¼š
   - é€šè¿‡ç›‘æ§æ•°æ®è‡ªåŠ¨ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
   - åŒ…å«å‚æ•°å·®å¼‚ã€é˜¶æ®µæ—¶é—´åˆ†å¸ƒç­‰åˆ†æ

4. **æ”¹è¿›å»ºè®®**ï¼š
   - åŸºäºç›‘æ§æ•°æ®æä¾›å‚æ•°è°ƒæ•´å»ºè®®
   - ä¸ºç³»ç»Ÿä¼˜åŒ–æŒ‡æ˜æ–¹å‘