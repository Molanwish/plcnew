# 自适应控制算法测试指南

## 概述

本文档提供了对自适应三阶段控制算法的系统化测试方法和步骤。目的是全面评估算法在不同条件下的性能表现，确保其在实际生产环境中能够稳定可靠地运行。

## 测试环境准备

### 1. 模拟测试环境
- 确保已安装Python 3.6+
- 安装所需依赖库：numpy, matplotlib, pandas

### 2. 实机测试环境
- 确保PLC连接正常
- 验证通信设置正确（COM端口、波特率等）
- 检查物料供应充足

## 测试方法

### 1. 基础性能测试

通过运行测试脚本进行初步评估：

```
python src/adaptive_algorithm/test_algorithm.py
```

这将执行默认测试配置（50个包装周期，目标重量1000g），并生成性能分析图表和数据文件。

基础测试指标：
- 平均重量与目标重量偏差
- 重量标准差和变异系数
- 阶段转换速度和稳定性

### 2. 参数敏感性测试

目的：评估算法对不同初始参数和学习率的敏感程度

步骤：
1. 修改测试脚本中的初始参数
   ```python
   # 修改controller初始化参数
   controller = AdaptiveThreeStageController({
       "learning_rate": 0.05,  # 测试不同学习率：0.05, 0.1, 0.15, 0.2
       "feeding_speed_coarse": 30.0,  # 测试不同初始速度
       "advance_amount_coarse": 1.5,  # 测试不同提前量
   })
   ```

2. 运行测试，记录每组参数的性能指标
3. 分析最佳参数组合和收敛速度

### 3. 目标重量范围测试

目的：验证算法在不同重量范围的适应能力

步骤：
1. 测试不同目标重量：100g, 500g, 1000g, 3000g, 5000g
   ```python
   # 修改测试重量
   target_weight = 500.0  # 设置不同的目标重量
   ```

2. 对每个重量范围运行至少30个周期
3. 比较不同重量下的准确度、稳定性和收敛速度
4. 记录每个重量范围的最优参数配置

### 4. 抗干扰能力测试

目的：评估算法对噪声和突发干扰的抵抗能力

步骤：
1. 增加系统噪声级别
   ```python
   # 增加噪声设置
   simulator = PackagingSimulator({
       "process_noise": 10.0,  # 增加为正常值的2倍
       "measurement_noise": 2.0,  # 增加为正常值的2倍
   })
   ```

2. 模拟突发干扰
   ```python
   # 在循环中添加突发干扰
   if i == 20:  # 第20个周期添加干扰
       result["weight"] += 50  # 添加大幅偏差
   ```

3. 测试参数突变适应性
   ```python
   # 模拟系统参数突变
   if i == 30:  # 第30个周期改变系统参数
       simulator.config["advance_amount_effect"] *= 1.5  # 提前量效应突变
   ```

### 5. 长期稳定性测试

目的：验证算法在长时间运行中的稳定性

步骤：
1. 增加测试周期数
   ```python
   # 设置更长的测试周期
   num_cycles = 200  # 增加到200或更多周期
   ```

2. 运行长时间测试，观察性能是否有下降趋势
3. 检查参数是否出现漂移或震荡
4. 分析长期运行数据，评估稳定性指标

### 6. 实机验证测试

目的：在实际硬件环境中验证算法性能

步骤：
1. 运行主应用程序
   ```
   python src/main.py
   ```

2. 在应用中进入"算法验证"或"智能生产"选项卡
3. 设置实际生产环境中的目标重量和参数
4. 执行以下测试：
   - 连续20个包装周期的稳定性测试
   - 在不同物料条件下的适应性测试
   - 系统启停后的参数恢复测试
   - 不同目标重量切换测试

## 数据记录与分析

每次测试应记录以下数据：
1. 测试配置参数
2. 性能指标统计
   - 平均重量和标准差
   - 目标偏差及最大偏差
   - 变异系数
   - 收敛周期数
3. 生成的CSV数据文件和性能图表

## 测试报告模板

```
测试日期：YYYY-MM-DD
测试人员：XXX
测试类型：[基础性能/参数敏感性/目标重量范围/抗干扰/长期稳定性/实机验证]

测试配置：
- 目标重量：XXXg
- 学习率：X.XX
- 初始参数：[详细参数列表]
- 噪声级别：XX
- 测试周期数：XX

测试结果：
- 平均重量：XXXg
- 标准差：XXg
- 变异系数：XX%
- 平均偏差：XXg
- 最大偏差：XXg
- 粗搜索→精搜索转换周期：XX
- 精搜索→维持转换周期：XX

结论：
[简要描述测试结果和发现的问题]

建议：
[提出改进建议]
```

## 测试进度计划

- 第一阶段：基础性能测试和参数敏感性测试 (1-2天)
- 第二阶段：目标重量范围测试和抗干扰测试 (2-3天)
- 第三阶段：长期稳定性测试 (3-5天)
- 第四阶段：实机验证测试 (5-7天)
- 第五阶段：整理测试报告，提出优化建议 (1-2天)

## 注意事项

1. 每种测试条件至少重复3次，取平均结果
2. 保存所有测试数据和图表，便于后续分析比较
3. 记录测试过程中的异常现象
4. 发现明显问题时应立即调整算法参数或代码
5. 实机测试前应先在模拟环境中充分验证

## 改进建议收集

针对测试中发现的问题，可考虑以下改进方向：

1. 动态学习率调整：根据性能指标自动调整学习率
2. 抗噪声能力增强：改进信号滤波算法
3. 智能初始参数选择：基于物料特性自动推荐参数
4. 预测性控制增强：结合历史数据预测系统行为
5. 故障检测与恢复：增加异常检测和自动恢复机制

## 附录：关键代码修改示例

### 学习率调整示例
```python
# 原始固定学习率
self.learning_rate = 0.1

# 改进为动态学习率
def _adjust_learning_rate(self):
    if self.current_stage == ControllerStage.COARSE_SEARCH:
        return 0.15
    elif self.current_stage == ControllerStage.FINE_SEARCH:
        # 随着性能提高逐渐降低学习率
        return 0.1 * (1 - min(0.8, self.performance_metrics["score"]))
    else:  # 维持阶段
        return 0.05
```

### 异常值检测示例
```python
def _is_outlier(self, weight, target_weight):
    # 判断是否为异常值
    if abs(weight - target_weight) / target_weight > 0.1:  # 超过10%
        return True
    
    # 检查与历史数据的偏差
    if len(self.weight_history) >= 5:
        recent_weights = self.weight_history[-5:]
        avg = sum(recent_weights) / len(recent_weights)
        if abs(weight - avg) / avg > 0.05:  # 超过最近平均值5%
            return True
    
    return False
``` 